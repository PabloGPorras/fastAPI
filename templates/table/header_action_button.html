<!-- Header Button Group -->
<script src="https://unpkg.com/htmx.org"></script>
<div class="btn-group">
    <!-- Primary Action Button -->
    {% if model_name != "request"%}
        <button class="btn btn-success btn-sm"
        hx-post="/get-create-new-form"
        hx-target="#createNewModalContainer"
        hx-trigger="click"
        hx-swap="innerHTML"
        hx-vals='{"model_name": "{{ model_name }}"}'>Create New</button>
    {% else %}
    <button class="btn btn-success btn-sm">
        Referesh
    </button>
    {% endif %}
    <!-- Dropdown for additional actions -->
    <button type="button" class="btn btn-success btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"
        aria-expanded="false"
        data-next-status="{{ status }}"
        hx-post="/status-transitions"
        hx-trigger="click"
        hx-include="#status-form"
        hx-vals='{"next_status": "{{ status }}"}'
        hx-target="#status-options-container">
        <span class="visually-hidden">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu">
        
        {% if model_name != "request"%}
        <li>
            <button class="dropdown-item">
                Referesh
            </button>
        </li>
        {% endif %}

        <li id="status-options-container" >
            <!-- Dynamic buttons will be inserted here -->
        </li>
        <li>
            <hr class="dropdown-divider">
        </li>

        <!-- Bulk Import Upload -->
        {% if model_name != "request"%}
        <li>
            <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#uploadBulkModal"
                data-model-name="{{ model_name }}">
                Bulk Import
            </button>
        </li>
        {% endif %}
    </ul>

    <div id="createNewModalContainer"></div>


    {% set model_name = model_name %}
    {% include "table/bulk_update_modal.html" with context %}


</div>
<script id="request-status-config" type="application/json">
    {{ request_status_config | tojson }}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    document.body.addEventListener("htmx:afterSwap", (event) => {
        if (event.detail.target.id === "createNewModalContainer") {
            const modalElement = document.getElementById("createNewModal");
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }
    });

    $(document).ready(async function () {
        const $tableBody = $("#tableBody");
        const $checkboxes = $tableBody.find(".row-checkbox");
        const $statusChangeButtons = $(".status-change-btn");
        const requestStatusConfig = JSON.parse($("#request-status-config").text());
        const $selectAllCheckbox = $("#selectAll");

        const modelName = "{{ model_name }}"; // Retrieve model_name directly from the template

        // Fetch current user roles using fetchCurrentUser
        await fetchCurrentUser();
        currentUserRoles = currentUserRoles ? currentUserRoles : [];

        // Event listener for status change buttons
        $statusChangeButtons.on("click", function () {
            const nextStatus = $(this).data("nextStatus");
            const $selectedRows = $tableBody.find("tr.selected-row");
            const rowIds = $selectedRows.map(function () {
                return $(this).data("id");
            }).get();

            const currentStatuses = $selectedRows.map(function () {
                const statusCell = $(this).find(".request_status-column");
                return statusCell.length ? statusCell.text().trim() : null;
            }).get();

            if (!rowIds.length) {
                alert("No rows selected.");
                return;
            }

            $.ajax({
                url: "/bulk-update-status",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    ids: rowIds,
                    currentStatuses,
                    nextStatus,
                    request_status_config: requestStatusConfig,
                }),
                success: function () {
                    location.reload(); // Reload to reflect changes
                },
                error: function (xhr) {
                    const errorDetail = xhr.responseJSON?.detail || "Error updating status.";
                    alert(errorDetail);
                },
            });
        });

    });

</script>