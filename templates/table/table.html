<style>
    /* Highlight selected rows */
    .selected-row {
        background-color: var(--table-selected-bg, #cce5ff) !important;
        color: var(--table-selected-text, #000000) !important;
    }

    /* Dark mode selected row */
    [data-bs-theme="dark"] .selected-row {
        background-color: var(--table-selected-bg, #4a4d52) !important;
        color: var(--table-selected-text, #ffffff) !important;
    }

    /* Base table styling */
    #tableContainer {
        padding: 15px;
    }

    /* Table Background and Borders */
    .table {
        border-collapse: collapse;
        width: 100%;
        background-color: var(--table-bg, #ffffff);
        border-radius: 8px;
        overflow: hidden;
    }

    /* Table Header Styling */
    .table thead th {
        background-color: var(--table-header-bg, #007bff);
        color: var(--table-header-text, #ffffff);
        font-weight: bold;
        padding: 12px;
        text-align: left;
    }

    /* Table Row Styling */
    .table tbody tr {
        background-color: var(--table-row-bg, #ffffff);
        color: var(--table-text, #000000);
        transition: background-color 0.3s ease;
    }

    /* Table Hover Effect */
    .table tbody tr:hover {
        background-color: var(--table-hover-bg, #f0f0f0);
    }

    /* Dark Mode Variables */
    [data-bs-theme="dark"] {
        --table-bg: #2c2f33;
        --table-header-bg: #23272a;
        --table-header-text: #ffffff;
        --table-row-bg: #2c2f33;
        --table-text: #ffffff;
        --table-hover-bg: #1e2124;
    }

    /* Checkbox and Button Styling */
    .row-checkbox {
        width: 20px;
        height: 20px;
    }

    .btn-primary {
        background-color: var(--table-header-bg, #007bff);
        border-color: var(--table-header-bg, #007bff);
    }
</style>


{% include "table/table_filters.html" %}
{% include "table/row_action_button.html" %}
<div id="tableContainer">
    <form id="status-form">
        <div class="table-responsive">
            <table id="dataTable" class="table table-bordered table-striped table-hover">
                <thead>
                    <tr id="tableHeaders">
                        <!-- Headers will be inserted here dynamically -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </form>
</div>


<script>
// Store the DataTable instance globally
let dataTableInstance;

$(document).ready(function () {
    $.ajax({
        url: `/table/{{ model_name }}/metadata`,
        type: "POST",
        success: function (response) {
            const columnOptions = response.column_options || {};
            const columns = response.columns.map((col) => ({
                title: col.toUpperCase(),
                data: col
            }));

            columns.unshift(getActionsColumn());

            if ($.fn.DataTable.isDataTable("#dataTable")) {
                $('#dataTable').DataTable().destroy();
                $("#tableHeaders").empty();
                $("#columnFilters").empty();
            }

            columns.forEach(col => {
                $("#tableHeaders").append(`<th>${col.title}</th>`);
            });

            // Initialize DataTable and store globally
            dataTableInstance = $('#dataTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: `/table/{{ model_name }}/data`,
                    type: "POST",
                    contentType: "application/json",
                    data: function (d) {
                        let filters = {};
                        $(".custom-filter, .custom-filter-input").each(function () {
                            let col = $(this).attr("data-column");
                            let val = $(this).val();
                            if (val) {
                                filters[col] = val;
                            }
                        });

                        return JSON.stringify({
                            draw: d.draw,
                            start: d.start,
                            length: d.length,
                            search_value: $("#customSearchInput").val(),
                            order_column_index: d.order?.[0]?.column ?? 0,
                            order_dir: d.order?.[0]?.dir ?? "asc",
                            filters: filters
                        });
                    },
                    dataSrc: function (json) {
                        return json.data;
                    },
                    error: function (xhr, error, code) {
                        console.error("❌ AJAX Error:", error, code, xhr.responseText);
                    }
                },
                columns: columns,
                paging: true,
                searching: true,
                ordering: true,
                colReorder: true,
                fixedHeader: true,
                scrollX: true,
                scrollY: "650px",
                scrollCollapse: true,
                lengthMenu: [10, 25, 50, 100],
                fixedColumns: { left: 1 },
                dom: 'lrtip',
                createdRow: function (row, data, dataIndex) {
                    $(row).attr('data-id', data.unique_ref);
                }
            });

            setupFilters(dataTableInstance, columnOptions, response.columns);
            setupColumnVisibility(dataTableInstance);

            $("#customSearchInput").on("keyup", debounce(function () {
                dataTableInstance.ajax.reload();
            }, 500));

            $("#dataTable tbody").on("click", "tr", function (event) {
                if (!$(event.target).hasClass('row-checkbox')) {
                    var checkbox = $(this).find('.row-checkbox');
                    checkbox.prop('checked', !checkbox.prop('checked'));
                    $(this).toggleClass('selected-row', checkbox.prop('checked'));
                }
            });

            // Enable row selection on click
            $('#dataTable tbody').on('click', 'tr', function (event) {
                if (!$(event.target).hasClass('row-checkbox')) {
                    var checkbox = $(this).find('.row-checkbox');
                    checkbox.prop('checked', !checkbox.prop('checked'));
                    $(this).toggleClass('selected-row', checkbox.prop('checked'));
                }
            });

            // Handle clicking the checkbox directly
            $('#dataTable tbody').on('change', '.row-checkbox', function () {
                $(this).closest('tr').toggleClass('selected-row', this.checked);
            });

            $("#dataTable tbody").on("change", ".row-checkbox", function () {
                $(this).closest("tr").toggleClass("selected-row", this.checked);
            });

            $("#refreshTableBtn").on("click", function () {
                refreshTable();
            });
        },
        error: function (xhr) {
            console.error("Error fetching table metadata:", xhr);
            $("#tableHeaders").html('<th colspan="100%" class="text-center text-danger">Failed to load columns</th>');
        }
    });
});

// Debounce function to limit how often a function is called
function debounce(func, delay) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

/**
 * ✅ Function to refresh the DataTable
 */
function refreshTable() {
    if (dataTableInstance) {
        dataTableInstance.ajax.reload(null, false);
    }
}

/**
 * ✅ Function to get selected row data
 */
function getSelectedRowsData() {
    if (!dataTableInstance) {
        console.error("DataTable instance is not initialized.");
        return [];
    }
    return dataTableInstance.rows('.selected-row').data().toArray();
}

</script>