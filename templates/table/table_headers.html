<style>
    /* Filter and Sort Icons */
    .filter-icon {
        font-size: 18px;
        position: relative;
        cursor: pointer;
    }

    .filter-icon::after {
        content: '';
        display: none;
        position: absolute;
        top: -4px;
        right: -4px;
        width: 8px;
        height: 8px;
        background-color: #007bff;
        /* Blue indicator for active filters */
        border-radius: 50%;
    }

    .filter-icon.active::after {
        display: block;
    }

    .sort-icon {
        margin-left: 5px;
        cursor: pointer;
        color: gray;
        /* Default color */
    }

    .sort-icon.active {
        color: #007bff;
        /* Active sort color */
    }

    /* Filter Menu */
    .filter-menu {
        display: none;
        position: absolute;
        background: var(--menu-bg-color, white);
        border: 1px solid #ccc;
        padding: 10px;
        z-index: 10;
    }

    .filter-menu.show {
        display: block;
    }
</style>
<thead>
    <tr>
        <!-- Blank Header for the First Column -->
        <th>
        </th>
        {% if rows and rows[0] %}
        {% for key in rows[0].keys() %}
        <th class="{{ key }}-column">
            {{ key|capitalize }}
            <button class="btn btn-link sort-btn" data-column="{{ key }}" data-order="asc">
                <span id="sort-{{ key }}" class="sort-icon">‚¨Ü</span>
            </button>
            <span class="filter-icon" data-column="{{ key }}" id="filter-icon-{{ key }}" title="Filter">üîç</span>
            <div class="filter-menu" id="filter-{{ key }}">
                <input type="text" class="form-control form-control-sm filter-input mb-2"
                    data-column="{{ key }}" placeholder="Filter {{ key|capitalize }}">
                <div class="d-flex justify-content-between">
                    <button class="btn btn-primary btn-sm apply-filter-btn"
                        data-column="{{ key }}">Apply</button>
                    <button class="btn btn-secondary btn-sm clear-filter-btn"
                        data-column="{{ key }}">Clear</button>
                </div>
            </div>
        </th>
        {% endfor %}
        {% endif %}
    </tr>
</thead>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Listen for the keydown event on the document
document.addEventListener('keydown', function (event) {
    // Check if the pressed key combination is "CTRL + SHIFT + A"
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'a') {
        event.preventDefault(); // Prevent default browser behavior

        // Select all row checkboxes
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });

        console.log('All rows selected with CTRL + SHIFT + A');
    }

    // Check if the pressed key combination is "CTRL + SHIFT + D"
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'd') {
        event.preventDefault(); // Prevent default browser behavior

        // Deselect all row checkboxes
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });

        console.log('All rows deselected with CTRL + SHIFT + D');
    }
});

document.addEventListener("DOMContentLoaded", async () => {
    // Fetch filters from the backend and apply them
    try {
        const response = await fetch("/api/get-user-preferences");
        const serverFilters = await response.json();
        localStorage.setItem("filters", JSON.stringify(serverFilters)); // Sync to local storage

        applyFilters(serverFilters);
    } catch (error) {
        console.error("Error fetching user preferences:", error);
    }

    // Restore filters from local storage and apply them
    const localFilters = JSON.parse(localStorage.getItem("filters") || "{}");
    applyFilters(localFilters);

    // Attach event listeners to filter buttons
    document.querySelectorAll(".apply-filter-btn").forEach((button) => {
        button.addEventListener("click", () => handleApplyFilter(button));
    });

    document.querySelectorAll(".clear-filter-btn").forEach((button) => {
        button.addEventListener("click", () => handleClearFilter(button));
    });

    // Attach event listeners for showing/hiding filter menus
    document.querySelectorAll(".filter-icon").forEach((icon) => {
        icon.addEventListener("click", (event) => toggleFilterMenu(event, icon));
    });

    // Close filter menus when clicking outside
    document.addEventListener("click", (event) => {
        if (!event.target.closest(".filter-icon, .filter-menu")) {
            document.querySelectorAll(".filter-menu").forEach((menu) => menu.classList.remove("show"));
        }
    });

    // Handle CTRL + SHIFT shortcuts for selecting/deselecting rows
    document.addEventListener("keydown", (event) => handleKeyboardShortcuts(event));

    // Handle sorting logic
    document.querySelectorAll(".sort-btn").forEach((button) => {
        button.addEventListener("click", (event) => handleSort(event, button));
    });
});

// Apply filters to the table rows
function applyFilters(filters) {
    for (const [column, value] of Object.entries(filters)) {
        const input = document.querySelector(`.filter-input[data-column="${column}"]`);
        if (input) {
            input.value = value;

            // Apply filter logic to rows
            const rows = document.querySelectorAll(`#tableBody .${column}-column`);
            rows.forEach((row) => {
                const cellValue = row.textContent.toLowerCase();
                const parentRow = row.closest("tr");
                parentRow.style.display = value && !cellValue.includes(value.toLowerCase()) ? "none" : ""; // Toggle row visibility
            });

            // Mark the filter as active
            const filterIcon = document.querySelector(`#filter-icon-${column}`);
            if (filterIcon) filterIcon.classList.add("active");
        }
    }
}

// Handle applying a filter
function handleApplyFilter(button) {
    const column = button.dataset.column;
    const input = document.querySelector(`.filter-input[data-column="${column}"]`);
    if (input) {
        const filters = JSON.parse(localStorage.getItem("filters") || "{}");
        filters[column] = input.value; // Save filter value
        localStorage.setItem("filters", JSON.stringify(filters));
        syncFiltersToServer(filters); // Sync filters with backend

        applyFilters({ [column]: input.value }); // Apply this filter
    }
}

// Handle clearing a filter
function handleClearFilter(button) {
    const column = button.dataset.column;
    const filters = JSON.parse(localStorage.getItem("filters") || "{}");
    delete filters[column]; // Remove filter
    localStorage.setItem("filters", JSON.stringify(filters));
    syncFiltersToServer(filters); // Sync filters with backend

    // Clear the input and reset rows
    const input = document.querySelector(`.filter-input[data-column="${column}"]`);
    if (input) input.value = "";

    const rows = document.querySelectorAll(`#tableBody .${column}-column`);
    rows.forEach((row) => row.closest("tr").style.display = ""); // Show all rows

    const filterIcon = document.querySelector(`#filter-icon-${column}`);
    if (filterIcon) filterIcon.classList.remove("active");
}

// Toggle filter menu visibility
function toggleFilterMenu(event, icon) {
    event.stopPropagation();
    const column = icon.dataset.column;
    const filterMenu = document.querySelector(`#filter-${column}`);

    // Hide other menus and toggle this one
    document.querySelectorAll(".filter-menu").forEach((menu) => {
        if (menu !== filterMenu) menu.classList.remove("show");
    });
    filterMenu.classList.toggle("show");
}

// Sync filters to backend
function syncFiltersToServer(filters) {
    fetch("/api/save-user-preferences", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preferences: filters }),
    }).catch((error) => console.error("Error syncing filters:", error));
}

// Handle keyboard shortcuts
function handleKeyboardShortcuts(event) {
    if (event.ctrlKey && event.shiftKey) {
        const key = event.key.toLowerCase();
        const checkboxes = document.querySelectorAll(".row-checkbox");

        if (key === "a") {
            event.preventDefault();
            checkboxes.forEach((checkbox) => (checkbox.checked = true));
            console.log("All rows selected with CTRL + SHIFT + A");
        } else if (key === "d") {
            event.preventDefault();
            checkboxes.forEach((checkbox) => (checkbox.checked = false));
            console.log("All rows deselected with CTRL + SHIFT + D");
        }
    }
}

// Handle sorting logic
function handleSort(event, button) {
    event.preventDefault();
    const column = button.dataset.column;
    const order = button.dataset.order;
    const sortIcon = document.querySelector(`#sort-${column}`);
    const rows = Array.from(document.querySelectorAll("#tableBody tr"));

    // Determine if the column is numeric
    const isNumeric = rows.some((row) => {
        const cell = row.querySelector(`.${column}-column`);
        return cell && !isNaN(parseFloat(cell.textContent));
    });

    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.querySelector(`.${column}-column`).textContent.trim();
        const bValue = b.querySelector(`.${column}-column`).textContent.trim();
        return isNumeric
            ? order === "asc"
                ? parseFloat(aValue) - parseFloat(bValue)
                : parseFloat(bValue) - parseFloat(aValue)
            : order === "asc"
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
    });

    // Append sorted rows back to the table
    const tableBody = document.querySelector("#tableBody");
    rows.forEach((row) => tableBody.appendChild(row));

    // Toggle sort order and update icon
    button.dataset.order = order === "asc" ? "desc" : "asc";
    sortIcon.textContent = order === "asc" ? "‚¨á" : "‚¨Ü";
}

</script>