<style>
    /* Filter and Sort Icons */
    .filter-icon {
        font-size: 18px;
        position: relative;
        cursor: pointer;
    }

    .filter-icon::after {
        content: '';
        display: none;
        position: absolute;
        top: -4px;
        right: -4px;
        width: 8px;
        height: 8px;
        background-color: #007bff;
        /* Blue indicator for active filters */
        border-radius: 50%;
    }

    .filter-icon.active::after {
        display: block;
    }

    .sort-icon {
        margin-left: 5px;
        cursor: pointer;
        color: gray;
        /* Default color */
    }

    .sort-icon.active {
        color: #007bff;
        /* Active sort color */
    }

    /* Filter Menu */
    .filter-menu {
        display: none;
        position: absolute;
        background: var(--menu-bg-color, white);
        border: 1px solid #ccc;
        padding: 10px;
        z-index: 10;
    }

    .filter-menu.show {
        display: block;
    }
</style>
<thead>
    <tr>
        <!-- Blank Header for the First Column -->
        <th >
        </th>
        {% for column in columns %}
        {% if not column.is_foreign_key %}
        <th class="{{ column.name }}-column">
            {{ column.name|capitalize }}
            <button class="btn btn-link sort-btn" data-column="{{ column.name }}" data-order="asc">
                <span id="sort-{{ column.name }}" class="sort-icon">‚¨Ü</span>
            </button>
            <span class="filter-icon" data-column="{{ column.name }}" id="filter-icon-{{ column.name }}"
                title="Filter">üîç</span>
            <div class="filter-menu" id="filter-{{ column.name }}">
                {% if column.options %}
                <select class="form-select form-select-sm filter-select mb-2" data-column="{{ column.name }}" multiple>
                    {% for option in column.options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
                {% else %}
                <input type="text" class="form-control form-control-sm filter-input mb-2"
                    data-column="{{ column.name }}" placeholder="Filter {{ column.name|capitalize }}">
                {% endif %}
                <div class="d-flex justify-content-between">
                    <button class="btn btn-primary btn-sm apply-filter-btn"
                        data-column="{{ column.name }}">Apply</button>
                    <button class="btn btn-secondary btn-sm clear-filter-btn"
                        data-column="{{ column.name }}">Clear</button>
                </div>
            </div>
        </th>
        {% endif %}
        {% endfor %}
    </tr>
</thead>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Apply stored group_id filter from sessionStorage
        const storedGroupId = sessionStorage.getItem("group_id");
        if (storedGroupId) {
            console.log("Found stored group_id:", storedGroupId);

            const $filterMenu = $("#filter-group_id");
            const $input = $filterMenu.find(".filter-input");
            const $filterIcon = $("#filter-icon-group_id");

            if ($filterMenu.length && $input.length) {
                // Set the filter value
                $input.val(storedGroupId);
                console.log("Setting group_id filter input value:", $input.val());

                // Trigger the filter logic by simulating the "Apply" button click
                const $applyButton = $filterMenu.find(".apply-filter-btn");
                if ($applyButton.length) {
                    console.log("Triggering Apply button for group_id filter.");
                    $applyButton.trigger("click");
                } else {
                    console.warn("Apply button not found for group_id filter.");
                }

                // Add the active class to the filter icon
                $filterIcon.addClass("active");
                console.log("Filter icon for group_id marked as active.");
            } else {
                console.warn("Filter menu or input for group_id not found.");
            }
        } else {
            console.log("No stored group_id found in sessionStorage.");
        }

        // Show/hide filter menus
        $(".filter-icon").on("click", function (event) {
            event.stopPropagation();
            const column = $(this).data("column");
            const $filterMenu = $(`#filter-${column}`);

            $(".filter-menu").not($filterMenu).removeClass("show");
            $filterMenu.toggleClass("show");
        });

        // Apply filter
        $(".apply-filter-btn").on("click", function () {
            event.preventDefault(); // Prevent the default button behavior
            const column = $(this).data("column");
            const $filterMenu = $(`#filter-${column}`);
            const $filterIcon = $(`#filter-icon-${column}`);
            let selectedValues = [];

            // Check if it's a multi-select or input filter
            const $select = $filterMenu.find(".filter-select");
            const $input = $filterMenu.find(".filter-input");

            if ($select.length) {
                // Multi-select: Get selected options
                selectedValues = $select.val().map((value) => value.toLowerCase());
            } else if ($input.length) {
                // Input field: Get text value
                selectedValues = [$input.val().toLowerCase()];
            }

            // Filter rows
            $(`#tableBody .${column}-column`).each(function () {
                const $row = $(this).closest("tr");
                const cellValue = $(this).text().toLowerCase();

                if (selectedValues.length > 0) {
                    if (selectedValues.some((value) => cellValue.includes(value))) {
                        $row.show(); // Show matching rows
                    } else {
                        $row.hide(); // Hide non-matching rows
                    }
                } else {
                    $row.show(); // Show all rows if no filter applied
                }
            });

            // Update filter icon state
            if (selectedValues.length > 0) {
                $filterIcon.addClass("active"); // Highlight the filter icon for active filters

                // Save filter value to sessionStorage
                if (column === "group_id" && $input.val()) {
                    sessionStorage.setItem("group_id", $input.val());
                }
            } else {
                $filterIcon.removeClass("active");

                // Remove filter from sessionStorage if empty
                if (column === "group_id") {
                    sessionStorage.removeItem("group_id");
                }
            }

            // Close the filter menu
            $filterMenu.removeClass("show");
        });

        // Clear filter
        $(".clear-filter-btn").on("click", function () {
            event.preventDefault(); // Prevent the default button behavior
            const column = $(this).data("column");
            const $filterMenu = $(`#filter-${column}`);
            const $filterIcon = $(`#filter-icon-${column}`);

            // Reset filters
            const $select = $filterMenu.find(".filter-select");
            const $input = $filterMenu.find(".filter-input");

            if ($select.length) {
                $select.prop("selectedIndex", -1); // Clear selection
            } else if ($input.length) {
                $input.val(""); // Clear input
            }

            // Show all rows
            $(`#tableBody .${column}-column`).each(function () {
                $(this).closest("tr").show();
            });

            // Remove filter icon state
            $filterIcon.removeClass("active");

            // Remove group_id filter from sessionStorage
            if (column === "group_id") {
                sessionStorage.removeItem("group_id");
            }

            // Close the filter menu
            $filterMenu.removeClass("show");
        });

        // Close filter menus when clicking outside
        $(document).on("click", function (event) {
            if (!$(event.target).closest(".filter-icon, .filter-menu").length) {
                $(".filter-menu").removeClass("show");
            }
        });

        // Sorting
        $(".sort-btn").on("click", function () {
            event.preventDefault(); // Prevent the default button behavior
            const column = $(this).data("column");
            const order = $(this).data("order");
            const $sortIcon = $(`#sort-${column}`);
            const $rows = $("#tableBody tr");

            // Determine if the column contains numeric data
            const isNumeric = $rows
                .find(`.${column}-column`)
                .toArray()
                .some((cell) => !isNaN(parseFloat($(cell).text())));

            $rows.sort(function (a, b) {
                const aValue = $(a).find(`.${column}-column`).text().trim();
                const bValue = $(b).find(`.${column}-column`).text().trim();

                if (isNumeric) {
                    return order === "asc"
                        ? parseFloat(aValue) - parseFloat(bValue)
                        : parseFloat(bValue) - parseFloat(aValue);
                } else {
                    return order === "asc"
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            $rows.appendTo("#tableBody");

            // Toggle sort order
            $(this).data("order", order === "asc" ? "desc" : "asc");

            // Update sort icon
            $(".sort-icon").not($sortIcon).text("‚¨Ü").removeClass("active");
            $sortIcon.text(order === "asc" ? "‚¨á" : "‚¨Ü").addClass("active");
        });
    });

</script>