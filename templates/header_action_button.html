<!-- Header Button Group -->
<div class="btn-group">

    <!-- Primary Action Button -->
    {% if primary_action %}
    <button id="primary-action-btn" class="btn btn-success btn-sm" data-endpoint="{{ primary_action.endpoint }}">
        {{ primary_action.label }}
    </button>
    {% endif %}
    <!-- Dropdown for additional actions -->
    <button type="button" class="btn btn-success btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"
        aria-expanded="false">
        <span class="visually-hidden">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu">
        {% for action in actions[1:] %}
        <li>
            <button class="dropdown-item requires-selection action-item" data-endpoint="{{ action.endpoint }}">
                {{ action.label }}
            </button>
        </li>
        {% endfor %}

        <!-- Status Change Buttons -->
        {% if request_status_config %}
        {% for status, config in request_status_config.items() %}
        <li>
            <button class="dropdown-item requires-selection status-change-btn" data-next-status="{{ status }}">
                Change to {{ status }}
            </button>
        </li>
        {% endfor %}
        {% endif %}

        <li>
            <hr class="dropdown-divider">
        </li>

        <!-- Bulk Import Upload -->
        {% if bulk_import_action %}
        <li>
            <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#uploadBulkModal" 
                data-model-name="{{ model_name }}">
                {{ bulk_import_action.label }}
            </button>
        </li>
        {% endif %}
    </ul>

    {% set model_name = model_name %}
    {% include "bulk_update_modal.html" with context %}


</div>
<script id="request-status-config" type="application/json">
    {{ request_status_config | tojson }}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(async function () {
    const $tableBody = $("#tableBody");
    const $checkboxes = $tableBody.find(".row-checkbox");
    const $selectAllCheckbox = $("#selectAll");
    const $statusChangeButtons = $(".status-change-btn");
    const requestStatusConfig = JSON.parse($("#request-status-config").text());
    let currentUserRoles = []; // Placeholder for current user's roles

    // Fetch current user information
    async function fetchCurrentUser() {
        try {
            const response = await fetch("/current-user");
            if (!response.ok) {
                throw new Error(`Failed to fetch current user. HTTP Status: ${response.status}`);
            }
            const userData = await response.json();
            currentUserRoles = userData.roles || [];
            console.log("Current user roles:", currentUserRoles);
        } catch (error) {
            console.error("Error fetching current user:", error);
            alert("Unable to fetch current user. Please try again.");
        }
    }

    // Call fetchCurrentUser to populate roles before proceeding
    await fetchCurrentUser();

    // Function to update visible status change buttons based on selected rows and user roles
    function updateStatusChangeButtons() {
        const $selectedRows = $tableBody.find("tr.selected-row");
        const currentStatuses = $selectedRows.map(function () {
            const statusCell = $(this).find(".request_status-column");
            return statusCell.length ? statusCell.text().trim() : null;
        }).get();

        let validTransitions = [];
        if (currentStatuses.length > 0) {
            validTransitions = requestStatusConfig[currentStatuses[0]]?.Next || [];
            currentStatuses.slice(1).forEach(status => {
                validTransitions = validTransitions.filter(transition =>
                    requestStatusConfig[status]?.Next.includes(transition)
                );
            });
        }

        // Show/Hide buttons based on valid transitions and user roles
        $statusChangeButtons.each(function () {
            const nextStatus = $(this).data("nextStatus");
            const requiredRoles = requestStatusConfig[nextStatus]?.Roles || [];
            const userHasRole = requiredRoles.some(role => currentUserRoles.includes(role));
            const isVisible = validTransitions.includes(nextStatus) && userHasRole;
            $(this).toggle(isVisible);
        });
    }

    // Add or remove the "selected-row" class when rows are clicked
    $tableBody.on("click", "tr", function (e) {
        if (!$(e.target).hasClass("row-checkbox")) {
            $(this).toggleClass("selected-row");
            const checkbox = $(this).find(".row-checkbox");
            checkbox.prop("checked", $(this).hasClass("selected-row"));
        }
        updateStatusChangeButtons();
    });

    // Event listener for Select All checkbox
    if ($selectAllCheckbox.length) {
        $selectAllCheckbox.on("change", function () {
            const isChecked = $(this).is(":checked");
            $checkboxes.prop("checked", isChecked);
            $checkboxes.each(function () {
                const $row = $(this).closest("tr");
                $row.toggleClass("selected-row", isChecked);
            });
            updateStatusChangeButtons();
        });
    }

    // Automatically update status buttons when a checkbox is clicked
    $checkboxes.on("change", function () {
        const $row = $(this).closest("tr");
        $row.toggleClass("selected-row", $(this).is(":checked"));
        updateStatusChangeButtons();
    });

    // Event listener for status change buttons
    $statusChangeButtons.on("click", function () {
        const nextStatus = $(this).data("nextStatus");
        const $selectedRows = $tableBody.find("tr.selected-row");
        const rowIds = $selectedRows.map(function () {
            return $(this).data("id");
        }).get();

        const currentStatuses = $selectedRows.map(function () {
            const statusCell = $(this).find(".request_status-column");
            return statusCell.length ? statusCell.text().trim() : null;
        }).get();

        if (!rowIds.length) {
            alert("No rows selected.");
            return;
        }

        $.ajax({
            url: "/bulk-update-status",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                ids: rowIds,
                currentStatuses,
                nextStatus,
                request_status_config: requestStatusConfig,
            }),
            success: function () {
                alert("Status updated successfully!");
                location.reload(); // Reload to reflect changes
            },
            error: function (xhr) {
                const errorDetail = xhr.responseJSON?.detail || "Error updating status.";
                alert(errorDetail);
            },
        });
    });

    // Event listener for primary-action-btn
    $("#primary-action-btn").on("click", function () {
        const endpoint = $(this).data("endpoint");

        if (endpoint === "/create-new-modal") {
            console.log("Primary action: Create New");

            // Reset the form
            const $form = $("#detailsForm");
            if (!$form.length) {
                console.error("Form with ID 'detailsForm' not found.");
                return;
            }
            $form[0].reset();

            // Clear relationship tables
            $(".relationship-container tbody").empty();

            // Enable all form fields
            $form.find("input, select, textarea").prop("disabled", false);

            // Show Add buttons for relationships
            $(".add-predefined-btn, .add-row-btn").show();

            // Reset modal title and button
            $("#createNewModalLabel").text("Create New Entry");
            const $saveButton = $("#createNewModal .btn-primary");
            $saveButton.text("Save").removeData("id").show();

            // Show the modal
            const modal = new bootstrap.Modal($("#createNewModal")[0]);
            modal.show();
        } else if (endpoint === "/refresh") {
            console.log("Primary action: Refresh");

            // Fetch updated data
            $.getJSON(endpoint, function (data) {
                console.log("Refreshed data:", data);

                // Replace table body with updated rows
                const $tableBody = $("#tableBody");
                $tableBody.empty(); // Clear the table
                data.rows.forEach(row => {
                    const rowElement = $(`
                        <tr>
                            <td>${row.id}</td>
                            <td>${row.name}</td>
                            <td>${row.status}</td>
                            <!-- Add other columns as needed -->
                        </tr>
                    `);
                    $tableBody.append(rowElement);
                });
            }).fail(function (error) {
                console.error("Error refreshing data:", error);
            });
        } else {
            console.error("Unknown primary action endpoint:", endpoint);
        }
    });
});

</script>