<style>
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    th {
        text-align: left !important;
    }

    .relationship-container {
        margin-bottom: 2rem;
    }

    .relationship-container .table th,
    .relationship-container .table td {
        vertical-align: middle;
    }

    .resizable {
        resize: vertical;
        /* Allow resizing only vertically */
        min-height: 50px;
        /* Minimum height for better UX */
        max-height: 300px;
        /* Optional: Limit maximum height */
    }
</style>

<!-- Predefined Fields for "is_request" Models -->
{% if is_request %}
<div class="row g-3">
    <!-- Organization -->
    <div class="col-md-2">
        <label for="organization" class="form-label">Organization</label>
        <select class="form-select" id="organization" name="organization" required>
            {% for option in RmsRequest.organization_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Sub Organization -->
    <div class="col-md-2">
        <label for="sub_organization" class="form-label">Sub Org</label>
        <select class="form-select" id="sub_organization" name="sub_organization" required>
            {% for option in RmsRequest.sub_organization_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Line of Business -->
    <div class="col-md-2">
        <label for="line_of_business" class="form-label">LOB</label>
        <select class="form-select" id="line_of_business" name="line_of_business" required>
            {% for option in RmsRequest.line_of_business_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Team -->
    <div class="col-md-2">
        <label for="team" class="form-label">Team</label>
        <select class="form-select" id="team" name="team" required>
            {% for option in RmsRequest.team_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Decision Engine -->
    <div class="col-md-2">
        <label for="decision_engine" class="form-label">Decision Engine</label>
        <select class="form-select" id="decision_engine" name="decision_engine" required>
            {% for option in RmsRequest.decision_engine_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Effort -->
    <div class="col-md-2">
        <label for="effort" class="form-label">Effort</label>
        <select class="form-select" id="effort" name="effort" required>
            {% for option in RmsRequest.effort_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>
</div>
{% endif %}


<!-- Existing Form Fields -->
{% for field in form_fields %}
{% if not field.is_foreign_key %}
<div class="mb-3">
    <label for="{{ field.name }}" class="form-label">{{ field.name|capitalize }}</label>
    {% if field.multi_options %}
    <!-- Dropdown for predefined multi-options -->
    <div>
        <select class="form-select" id="{{ field.name }}" name="{{ field.name }}" multiple required>
            {% for option in field.multi_options %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>
    </div>
    {% elif field.options %}
    <!-- Dropdown for predefined options -->
    <select class="form-select" id="{{ field.name }}" name="{{ field.name }}" required>
        {% for option in field.options %}
        <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
    </select>
    {% elif "INTEGER" in field.type %}
    <!-- Input for INTEGER -->
    <input type="number" class="form-control" id="{{ field.name }}" name="{{ field.name }}" required>
    {% elif "BOOLEAN" in field.type %}
    <!-- Dropdown for BOOLEAN -->
    <select class="form-select" id="{{ field.name }}" name="{{ field.name }}" required>
        <option value="true">True</option>
        <option value="false">False</option>
    </select>
    {% elif "DATE" in field.type and not "DATETIME" in field.type %}
    <!-- Input for DATE -->
    <input type="date" class="form-control" id="{{ field.name }}" name="{{ field.name }}" required>
    {% elif "TIME" in field.type and not "DATETIME" in field.type %}
    <!-- Input for TIME -->
    <input type="time" class="form-control" id="{{ field.name }}" name="{{ field.name }}" required>
    {% elif "DATETIME" in field.type %}
    <!-- Input for DATETIME -->
    <input type="datetime-local" class="form-control" id="{{ field.name }}" name="{{ field.name }}" required>
    {% else %}
    <!-- Textarea for TEXT or STRING with resizable style -->
    <textarea class="form-control resizable" id="{{ field.name }}" name="{{ field.name }}" rows="1" required></textarea>
    {% endif %}
</div>
{% endif %}
{% endfor %}

<!-- Dynamically Generated Relationship Subtables -->
{% for relationship in relationships if not relationship.info.get("exclude_from_form", False) %}
<h5>{{ relationship.name|capitalize }}</h5>
<div id="{{ relationship.name }}-container" class="relationship-container">
    <table class="table">
        <thead>
            <tr>
                {% for field in relationship.fields %}
                <th>{{ field.name|capitalize }}</th>
                {% endfor %}
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows added dynamically -->
        </tbody>
    </table>

    <!-- Predefined Options Dropdown -->
    {% if predefined_options[relationship.name] %}
    <div class="mt-2">
        <label for="{{ relationship.name }}_options" class="form-label">{{ relationship.name|capitalize }}
            Options</label>
        <select class="form-select" id="{{ relationship.name }}_options">
            {% for option in predefined_options[relationship.name] %}
            <option value="{{ option.id }}">{{ option.name }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-secondary btn-sm mt-2 add-predefined-btn"
            data-relationship="{{ relationship.name }}">
            Add Selected {{ relationship.name|capitalize }}
        </button>
    </div>
    {% else %}
    <!-- Add button for user-defined relationships -->
    <button type="button" class="btn btn-secondary btn-sm mt-2 add-row-btn" data-relationship="{{ relationship.name }}">
        Add {{ relationship.name|capitalize }}
    </button>
    {% endif %}
</div>
{% endfor %}




<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    <button type="submit" class="btn btn-primary">Save</button>
</div>
<script id="is-request-config" type="application/json">
    {{ is_request | tojson }}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(async function () {
    let currentUserId;

    // Fetch current user information
    async function fetchCurrentUser() {
        try {
            const response = await fetch("/current-user");
            if (!response.ok) {
                throw new Error(`Failed to fetch current user. HTTP Status: ${response.status}`);
            }
            const userData = await response.json();
            currentUserId = userData.user_name; // Set current user ID
        } catch (error) {
            console.error("Error fetching current user:", error);
            alert("Unable to fetch current user. Please try again.");
        }
    }

    // Load comments dynamically for the current item
    async function loadComments(itemId) {
        const $commentsList = $("#comments-list");
        $commentsList.empty();

        try {
            const response = await fetch(`/requests/${itemId}/comments`);
            if (!response.ok) {
                throw new Error(`Failed to fetch comments. HTTP Status: ${response.status}`);
            }

            const comments = await response.json();
            if (comments.length === 0) {
                $commentsList.append('<div class="no-comments">No comments available.</div>');
                return;
            }

            comments.forEach((comment) => {
                const alignmentClass = comment.user_name === currentUserId ? "right" : "left";
                const commentItem = `
                    <div class="comment-item ${alignmentClass}">
                        <div class="timestamp">${new Date(comment.comment_timestamp).toLocaleString()}</div>
                        <div class="user-info">User: ${comment.user_name}</div>
                        <div class="comment-text">${comment.comment}</div>
                    </div>
                `;
                $commentsList.append(commentItem);
            });
        } catch (error) {
            console.error("Error loading comments:", error);
            alert("Failed to load comments. Please try again.");
        }
    }

    // Add a new comment
    $("#addCommentButton").on("click", async function () {
        const commentText = $("#commentText").val().trim();
        const $modal = $("#createNewModal");
        const itemId = $modal.attr("data-id");

        if (!commentText) {
            alert("Comment text cannot be empty.");
            return;
        }

        try {
            const response = await fetch(`/requests/${itemId}/comments`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ comment_text: commentText, username: currentUserId }),
            });

            if (!response.ok) {
                throw new Error(`Failed to submit comment: ${response.statusText}`);
            }

            const newComment = await response.json();
            const alignmentClass = newComment.username === currentUserId ? "right" : "left";
            const commentItem = `
                <div class="comment-item ${alignmentClass}">
                    <div class="timestamp">${new Date(newComment.comment_timestamp).toLocaleString()}</div>
                    <div class="user-info">User: ${newComment.username}</div>
                    <div class="comment-text">${newComment.comment_text}</div>
                </div>
            `;
            $("#comments-list").append(commentItem);
            $("#commentText").val(""); // Clear input
        } catch (error) {
            console.error("Error adding comment:", error);
            alert("Failed to add comment.");
        }
    });

    // Load comments when the modal is opened
    $("#createNewModal").on("shown.bs.modal", function () {
        const itemId = $(this).attr("data-id");
        if (itemId) {
            loadComments(itemId);
        }
    });

    // Initialize by fetching the current user
    await fetchCurrentUser();
});
</script>