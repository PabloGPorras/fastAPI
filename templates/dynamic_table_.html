{% extends "base.html" %}

{% block title %}Dynamic Table{% endblock %}

{% block content %}
<style>
    /* Prevent table headers from wrapping */
    th {
        white-space: nowrap;
        /* Prevent wrapping */
        text-align: center;
        /* Optional: Center align the text */
        vertical-align: middle;
        /* Optional: Center align vertically */
    }
</style>

<div class="container mt-5">
    <h2>Dynamic Table with Sorting and Filtering</h2>
    <div class="mb-3 d-flex gap-2">
        <!-- Manage Columns Button -->
        {% include "manage_columns_button.html" %}

        {% set model_name = model_name %}
        {% include "header_action_button.html" with context %}

    </div>
    <div id="manage-columns-menu" class="border p-2"
        style="display: none; max-height: 200px; overflow-y: auto; width: 250px;">
        <form>
            {% for column in columns %}
            <div class="form-check">
                <input class="form-check-input column-toggle" type="checkbox" id="toggle-{{ column.name }}"
                    data-column="{{ column.name }}" checked>
                <label class="form-check-label" for="toggle-{{ column.name }}">{{ column.name|capitalize }}</label>
            </div>
            {% endfor %}
        </form>
    </div>
    <!-- Table -->
    <table class="table table-bordered">
        {% include "table_headers.html" %}
        <tbody id="tableBody">
            {% for row in rows %}
            <tr data-id="{{ row.get('id', 'N/A') }}" data-model-name="{{ model_name }}">
                <!-- Button Group in the First Column -->
                <td>
                    <div class="btn-group">
                        <!-- Primary Button with Bolt Icon -->
                        <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="fas fa-bolt"></i> <!-- Font Awesome icon -->
                        </button>
                        <!-- Dropdown Menu -->
                        <ul class="dropdown-menu">
                            <li>
                                <button class="dropdown-item view-btn"
                                    data-id="{{ row.get('id', 'N/A') }}">View</button>
                            </li>
                        </ul>
                    </div>
                </td>


                <!-- Dynamic Row Data -->
                {% for column in columns %}
                <td class="{{ column.name }}-column">
                    {{ row.get(column.name, "N/A") }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<div class="modal fade" id="createNewModal" tabindex="-1" aria-labelledby="createNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNewModalLabel">Request Details</h5>
            </div>

            <!-- Details Form -->
            <form id="detailsForm">
                <div class="modal-body">
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs" id="itemModalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                                data-bs-target="#details-tab-pane" type="button" role="tab"
                                aria-controls="details-tab-pane" aria-selected="true">Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                                data-bs-target="#comments-tab-pane" type="button" role="tab"
                                aria-controls="comments-tab-pane" aria-selected="false">Comments</button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="itemModalTabsContent">
                        <!-- Details Tab -->
                        <div class="tab-pane fade show active" id="details-tab-pane" role="tabpanel"
                            aria-labelledby="details-tab">
                            {% include "request_details_form.html" %}
                        </div>

                        <!-- Comments Tab -->
                        <div class="tab-pane fade" id="comments-tab-pane" role="tabpanel"
                            aria-labelledby="comments-tab">
                            {% include "comments_form.html" %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>








<script id="props-data" type="application/json">
    {{ {"form_fields": form_fields, "relationships": relationships, "model_name": model_name} | tojson | safe }}
</script>

<script>
    // Run this on page load to initialize the dropdown state
    updateDropdownActions();

    // Utility function to format field names
    function formatFieldName(fieldName) {
        return fieldName
            .split("_") // Split the string by underscores
            .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize the first letter of each word
            .join(" "); // Join the words with a space
    }


    document.addEventListener("keydown", function (event) {
        const isCtrlPressed = event.ctrlKey || event.metaKey; // For macOS, `metaKey` is Cmd

        if (isCtrlPressed && event.key.toLowerCase() === "a") {
            event.preventDefault(); // Prevent default browser behavior

            // Select all rows
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.classList.add("selected-row"); // Add the selected class
            });

            updateDropdownActions(); // Update dropdown actions
        }

        if (isCtrlPressed && event.key.toLowerCase() === "d") {
            event.preventDefault(); // Prevent default browser behavior

            // Deselect all rows
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.classList.remove("selected-row"); // Remove the selected class
            });

            updateDropdownActions(); // Update dropdown actions
        }
    });

    // Function to load comments
    async function loadComments(requestId) {
        // Current user ID (replace this with your actual user identification logic)
        const currentUserId = "User123";

        const commentsList = document.getElementById("comments-list");
        commentsList.innerHTML = ""; // Clear previous comments

        try {
            const response = await fetch(`/requests/${requestId}/comments`);
            if (!response.ok) {
                throw new Error("Failed to load comments.");
            }

            const comments = await response.json();
            comments.forEach(comment => {
                const commentItem = document.createElement("div");
                commentItem.classList.add("comment-item");

                // Determine alignment based on user
                if (comment.username === currentUserId) {
                    commentItem.classList.add("right");
                } else {
                    commentItem.classList.add("left");
                }

                // Add content to the comment item
                commentItem.innerHTML = `
                    <div class="timestamp">${new Date(comment.timestamp).toLocaleString()}</div>
                    <div class="user-info">User ID: ${comment.username}</div>
                    <div class="comment-text">${comment.comment_text}</div>
                `;

                commentsList.appendChild(commentItem);
            });
        } catch (error) {
            console.error("Error loading comments:", error);
            alert("Failed to load comments.");
        }
    }


    document.addEventListener("DOMContentLoaded", function () {



        document.querySelectorAll(".view-btn").forEach(button => {
            button.addEventListener("click", async function () {
                const id = this.getAttribute("data-id");
                const row = this.closest("tr");
                const modelName = row.getAttribute("data-model-name");

                // Find the "request_type" column value from the row
                const requestTypeElement = row.querySelector(".request_type-column");
                const requestType = requestTypeElement ? requestTypeElement.textContent.trim() : null;
                const groupIdElement = row.querySelector(".group_id-column");
                const groupId = groupIdElement ? groupIdElement.textContent.trim() : null;

                if (id === "N/A" || !modelName) {
                    alert("Invalid row ID or model name.");
                    return;
                }

                if (requestType) {
                    // Navigate to the appropriate page if request type exists
                    sessionStorage.setItem("filter_id", id);
                    sessionStorage.setItem("filter_id", groupId);
                    const url = `/table/${modelName}`;
                    window.location.href = url;
                } else {
                    try {
                        // Fetch details
                        const response = await fetch(`/get-details/${modelName}/${id}`);
                        if (!response.ok) {
                            console.error("HTTP error:", response.status, response.statusText);
                            alert("Failed to fetch details. Please try again.");
                            return;
                        }

                        const { data, relationships } = await response.json();
                        populateDetailsForm(data, relationships);

                        // Clear and enable the comments text field
                        const commentInput = document.getElementById("commentText");
                        commentInput.value = "";
                        commentInput.removeAttribute("disabled");

                        // Load comments
                        await loadComments(id);

                        // Update modal attributes for proper context
                        const modal = document.getElementById("createNewModal");
                        modal.setAttribute("data-model-name", modelName);
                        modal.setAttribute("data-id", id);

                        // Show the modal
                        const bootstrapModal = new bootstrap.Modal(modal);
                        bootstrapModal.show();
                    } catch (error) {
                        console.error("Error fetching details:", error);
                        alert("An error occurred while fetching details.");
                    }
                }
            });
        });









    });



    // Handle Dropdown Actions for specific action items
    document.querySelectorAll(".action-item").forEach(item => {
        item.addEventListener("click", async function () {
            const endpoint = this.dataset.endpoint; // Get the endpoint
            const selectedRows = document.querySelectorAll(".selected-row");

            if (selectedRows.length === 0) {
                return; // Stop execution if no rows are selected
            }

            // Collect IDs of selected rows
            const selectedIds = Array.from(selectedRows).map(row => row.dataset.id);

            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ids: selectedIds }), // Send valid JSON
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Action completed successfully: ${result.message}`);
                    location.reload(); // Optionally refresh the page
                } else {
                    alert(`Action failed: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error performing action:", error);
                alert("An error occurred while performing the action.");
            }
        });
    });

    document.querySelectorAll("#tableBody tr").forEach(row => {
        row.addEventListener("click", function (event) {
            // Prevent the checkbox click from toggling the row twice
            if (event.target.classList.contains("row-checkbox")) return;

            const checkbox = this.querySelector(".row-checkbox");
            if (checkbox) {
                checkbox.checked = !checkbox.checked; // Sync checkbox state
            }
            this.classList.toggle("selected-row"); // Toggle row selection class
            updateDropdownActions(); // Update actions for selected rows
        });
    });


</script>
{% endblock %}