{% extends "base.html" %}

{% block title %}Dynamic Table{% endblock %}

{% block content %}
<style>
    /* Prevent table headers from wrapping */
    th {
        white-space: nowrap;
        /* Prevent wrapping */
        text-align: center;
        /* Optional: Center align the text */
        vertical-align: middle;
        /* Optional: Center align vertically */
    }
</style>

<div class="container-fluid mt-5">
    <h2>Dynamic Table with Sorting and Filtering</h2>
    <div class="mb-3 d-flex gap-2">
        <!-- Manage Columns Button -->
        {% include "manage_columns_button.html" %}

        {% set model_name = model_name %}
        {% include "header_action_button.html" with context %}

    </div>
    <div id="manage-columns-menu" class="border p-2"
        style="display: none; max-height: 200px; overflow-y: auto; width: 250px;">
        <form>
            {% for column in columns %}
            <div class="form-check">
                <input class="form-check-input column-toggle" type="checkbox" id="toggle-{{ column.name }}"
                    data-column="{{ column.name }}" checked>
                <label class="form-check-label" for="toggle-{{ column.name }}">{{ column.name|capitalize }}</label>
            </div>
            {% endfor %}
        </form>
    </div>
    <!-- Table -->
    <table class="table table-bordered" class="table">
        {% include "table_headers.html" %}
        <tbody id="tableBody">
            {% for row in rows %}
            <tr data-id="{{ row.get('unique_ref', 'N/A') }}" data-model-name="{{ model_name }}">
                <!-- Button Group in the First Column -->
                <td>
                    <div class="btn-group">
                        <!-- Primary Button with Bolt Icon -->
                        <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="fas fa-bolt"></i> <!-- Font Awesome icon -->
                        </button>
                        <!-- Dropdown Menu -->
                        <ul class="dropdown-menu">
                            <li>
                                <button class="dropdown-item view-btn"
                                    data-id="{{ row.get('unique_ref', 'N/A') }}">View</button>
                            </li>
                        </ul>
                    </div>
                </td>


                <!-- Dynamic Row Data -->
                {% for column in columns %}
                <td class="{{ column.name }}-column">
                    {{ row.get(column.name, "N/A") }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<div class="modal fade" id="createNewModal" tabindex="-1" aria-labelledby="createNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNewModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" id="itemModalTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                            data-bs-target="#details-tab-pane" type="button" role="tab" aria-controls="details-tab-pane"
                            aria-selected="true">
                            Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                            data-bs-target="#comments-tab-pane" type="button" role="tab"
                            aria-controls="comments-tab-pane" aria-selected="false">
                            Comments
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Details Tab -->
                    <div class="tab-pane fade show active" id="details-tab-pane" role="tabpanel"
                        aria-labelledby="details-tab">
                        <form id="detailsForm">
                            {% include "request_details_form.html" %}
                        </form>
                    </div>

                    <!-- Comments Tab -->
                    {% include "comments_form.html" %}
                </div>
            </div>
        </div>
    </div>
</div>



<script id="props-data" type="application/json">
    {{ {"form_fields": form_fields, "relationships": relationships, "model_name": model_name} | tojson | safe }}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(async function () {
        console.log("Page initialized. Setting up event listeners.");
    
        // Fetch current user information before setting up functionality
        try {
            await fetchCurrentUser();
            console.log("Current user fetched successfully.");
        } catch (error) {
            console.error("Error fetching current user:", error);
            return; // Exit if user fetch fails
        }
    
        // Utility function to log event delegation
        function logEvent(element, event, message) {
            console.log(`Event '${event}' triggered on`, element);
            console.log(message);
        }
    
        // View button functionality
        $(document).on("click", ".view-btn", async function () {
            logEvent(this, "click", "View button clicked.");
    
            const $row = $(this).closest("tr");
            const id = $row.data("id");
            const modelName = $row.data("model-name");
    
            console.log("Extracted row data:", { id, modelName });
    
            if (!id || id === "N/A" || !modelName) {
                alert("Invalid row ID or model name.");
                console.error("Invalid row ID or model name:", { id, modelName });
                return;
            }
    
            const requestType = $row.find(".request_type-column").text().trim();
            const groupId = $row.find(".group_id-column").text().trim();
    
            console.log("Extracted request type and group ID:", { requestType, groupId });
    
            if (requestType) {
                console.log("Navigating to filtered page:", `/table/${requestType.toLowerCase()}`);
                sessionStorage.setItem("filter_id", id);
                sessionStorage.setItem("group_id", groupId);
                window.location.href = `/table/${requestType.toLowerCase()}`;
            } else {
                console.log("Making backend request for details:", { modelName, id });
                try {
                    const response = await fetch(`/get-details/${modelName}/${id}`);
                    console.log("Backend response received:", response);
    
                    if (!response.ok) {
                        console.error("HTTP error from backend:", {
                            status: response.status,
                            statusText: response.statusText,
                        });
                        alert("Failed to fetch details. Please try again.");
                        return;
                    }
    
                    const { data, relationships } = await response.json();
                    console.log("Data received from backend:", { data, relationships });
    
                    if (typeof populateDetailsForm === "function") {
                        console.log("Populating details form.");
                        populateDetailsForm(data, relationships);
                    } else {
                        console.warn("populateDetailsForm function not found.");
                    }
    
                    $("#commentText").val("").prop("disabled", false);
    
                    if (typeof loadComments === "function") {
                        console.log("Loading comments for:", id);
                        await loadComments(id);
                    } else {
                        console.warn("loadComments function not found.");
                    }
    
                    const $modal = $("#createNewModal");
                    $modal.attr("data-model-name", modelName).attr("data-id", id);
                    console.log("Showing modal for:", { modelName, id });
                    const bootstrapModal = new bootstrap.Modal(document.getElementById("createNewModal"));
                    bootstrapModal.show();
                } catch (error) {
                    console.error("Error fetching details from backend:", error);
                    alert("An error occurred while fetching details.");
                }
            }
        });
    
        // Function to update actions dropdown
        function updateDropdownActions() {
            const $selectedRows = $("#tableBody tr.selected-row");
            console.log("Dropdown actions updated. Selected rows:", $selectedRows.length);
            // Add additional logic for enabling/disabling dropdown actions if needed
        }
    

    

        // Add Select All and Deselect All shortcuts
        $(document).on("keydown", function (event) {
            const isCtrlPressed = event.ctrlKey || event.metaKey; // Support macOS Command key
    
            if (isCtrlPressed && event.key.toLowerCase() === "a") {
                event.preventDefault(); // Prevent default browser behavior
                console.log("Select All triggered.");
                $("#tableBody tr").addClass("selected-row"); // Add the selected class
                $("#tableBody .row-checkbox").prop("checked", true); // Check all checkboxes
                updateDropdownActions(); // Update actions for selected rows
            }
    
            if (isCtrlPressed && event.key.toLowerCase() === "d") {
                event.preventDefault(); // Prevent default browser behavior
                console.log("Deselect All triggered.");
                $("#tableBody tr").removeClass("selected-row"); // Remove the selected class
                $("#tableBody .row-checkbox").prop("checked", false); // Uncheck all checkboxes
                updateDropdownActions(); // Update actions for deselection
            }
        });
    });
    </script>
    
{% endblock %}