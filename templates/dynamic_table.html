<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Dynamic Table with Sorting and Filtering</title>
    <style>
        #manage-columns-menu {
            position: absolute;
            background: white;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            z-index: 1000;
        }

        .selected-row {
            background-color: #d3e4f7 !important;
        }

        .filter-icon {
            font-size: 18px;
            position: relative;
            cursor: pointer;
        }

        .filter-icon::after {
            content: '';
            display: none;
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background-color: #007bff;
            /* Blue indicator for active filters */
            border-radius: 50%;
        }

        .filter-icon.active::after {
            display: block;
        }

        .sort-icon {
            margin-left: 5px;
            cursor: pointer;
            color: gray;
            /* Default color */
        }

        .sort-icon.active {
            color: #007bff;
            /* Active sort color */
        }

        .filter-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 10;
        }

        .filter-menu.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2>Dynamic Table with Sorting and Filtering</h2>
        <div class="mb-3 d-flex gap-2">
            <!-- Manage Columns Button -->
            <button id="manage-columns-btn" class="btn btn-primary btn-sm">Manage Columns</button>

            <div class="btn-group">
                <!-- Primary Button triggers the modal -->
                <button id="primary-action-btn" class="btn btn-success btn-sm" data-bs-toggle="modal"
                    data-bs-target="#createNewModal">
                    Create New
                </button>
                <!-- Dropdown for additional actions -->
                <button type="button" class="btn btn-success btn-sm dropdown-toggle dropdown-toggle-split"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    {% for action in actions[1:] %}
                    <li>
                        <button class="dropdown-item" data-endpoint="{{ action.endpoint }}">
                            {{ action.label }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
            </div>

        </div>

        <div id="manage-columns-menu" class="border p-2"
            style="display: none; max-height: 200px; overflow-y: auto; width: 250px;">
            <form>
                {% for column in columns %}
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggle-{{ column.name }}"
                        data-column="{{ column.name }}" checked>
                    <label class="form-check-label" for="toggle-{{ column.name }}">{{ column.name|capitalize }}</label>
                </div>
                {% endfor %}
            </form>
        </div>
        <!-- Table -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    {% for column in columns %}
                    <th class="{{ column.name }}-column">
                        {{ column.name|capitalize }}
                        <button class="btn btn-link sort-btn" data-column="{{ column.name }}" data-order="asc">
                            <span id="sort-{{ column.name }}" class="sort-icon">‚¨Ü</span>
                        </button>
                        <span class="filter-icon" data-column="{{ column.name }}" id="filter-icon-{{ column.name }}"
                            title="Filter">üîç</span>
                        <div class="filter-menu" id="filter-{{ column.name }}">
                            {% if column.options %}
                            <select class="form-select form-select-sm filter-select mb-2"
                                data-column="{{ column.name }}" multiple>
                                {% for option in column.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="text" class="form-control form-control-sm filter-input mb-2"
                                data-column="{{ column.name }}" placeholder="Filter {{ column.name|capitalize }}">
                            {% endif %}
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm apply-filter-btn"
                                    data-column="{{ column.name }}">Apply</button>
                                <button class="btn btn-secondary btn-sm clear-filter-btn"
                                    data-column="{{ column.name }}">Clear</button>
                            </div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for row in rows %}
                <tr>
                    {% for column in columns %}
                    <td class="{{ column.name }}-column">{{ getattr(row, column.name) }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Create New Modal -->
    <div class="modal fade" id="createNewModal" tabindex="-1" aria-labelledby="createNewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createNewModalLabel">Create New Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createNewForm">
                    <div class="modal-body">
                        {% for field in form_fields %}
                        <div class="mb-3">
                            <label for="{{ field.name }}" class="form-label">{{ field.name|capitalize }}</label>
                            {% if field.options %}
                            <select class="form-select" id="{{ field.name }}" name="{{ field.name }}">
                                {% for option in field.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                            {% elif field.type == "INTEGER" %}
                            <input type="number" class="form-control" id="{{ field.name }}" name="{{ field.name }}">
                            {% else %}
                            <input type="text" class="form-control" id="{{ field.name }}" name="{{ field.name }}">
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>

            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>


        // Enable or disable the dropdown based on selected rows
        function updateActionDropdown() {
            const selectedRows = document.querySelectorAll(".selected-row");
            const actionDropdown = document.getElementById("action-dropdown");
            actionDropdown.disabled = selectedRows.length === 0; // Enable if any rows are selected
        }


        document.getElementById("createNewForm").addEventListener("submit", async function (event) {
            event.preventDefault(); // Prevent the form from submitting traditionally

            const formData = new FormData(this); // Capture form data
            const formObject = {};

            // Convert FormData to a plain object
            formData.forEach((value, key) => {
                formObject[key] = value;
            });

            try {
                const response = await fetch("/create-new", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formObject),
                });

                if (response.ok) {
                    const result = await response.json();
                    // Optionally close the modal and refresh the table
                    const modalElement = document.getElementById("createNewModal");
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    modalInstance.hide();
                    // Refresh the table or reload the page
                    location.reload(); // Or update the table dynamically
                } else {
                    alert(`Failed to create entry: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                alert("An error occurred while creating the entry.");
            }
        });


        // Handle Dropdown Actions
        document.querySelectorAll(".dropdown-item").forEach(item => {
            item.addEventListener("click", async function () {
                const endpoint = this.dataset.endpoint; // Get the endpoint from the dropdown item's data attribute
                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(`Action completed successfully: ${result.message}`);
                    } else {
                        alert(`Action failed: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Error performing action:", error);
                    alert("An error occurred while performing the action.");
                }
            });
        });



        // Manage Columns Menu Toggle
        document.getElementById("manage-columns-btn").addEventListener("click", () => {
            const menu = document.getElementById("manage-columns-menu");
            menu.style.display = menu.style.display === "none" ? "block" : "none";
        });

        // Column Toggle Logic
        document.querySelectorAll(".column-toggle").forEach(toggle => {
            toggle.addEventListener("change", function () {
                const column = this.dataset.column;
                const th = document.querySelector(`th.${column}-column`);
                const tds = document.querySelectorAll(`td.${column}-column`);

                if (this.checked) {
                    th.style.display = ""; // Show column
                    tds.forEach(td => td.style.display = "");
                } else {
                    th.style.display = "none"; // Hide column
                    tds.forEach(td => td.style.display = "none");
                }
            });
        });


        // Consolidated row selection logic
        document.querySelectorAll("#tableBody tr").forEach(row => {
            row.addEventListener("click", function (event) {
                // Prevent the click from affecting nested elements
                event.stopPropagation();

                // Toggle the "selected-row" class
                if (row.style.display !== "none") { // Only handle visible rows
                    row.classList.toggle("selected-row");
                }

                // Update the action dropdown state
                updateActionDropdown();
            });
        });

        // Show/hide filter menus
        document.querySelectorAll(".filter-icon").forEach(icon => {
            icon.addEventListener("click", function (event) {
                event.stopPropagation();
                const column = this.dataset.column;
                const filterMenu = document.getElementById(`filter-${column}`);
                document.querySelectorAll(".filter-menu").forEach(menu => {
                    if (menu !== filterMenu) {
                        menu.classList.remove("show");
                    }
                });
                filterMenu.classList.toggle("show");
            });
        });

        // Apply filter
        document.querySelectorAll(".apply-filter-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const filterIcon = document.getElementById(`filter-icon-${column}`);
                const filterMenu = document.getElementById(`filter-${column}`);
                let selectedValues = [];

                // Check if it's a multi-select or input filter
                const select = filterMenu.querySelector(".filter-select");
                const input = filterMenu.querySelector(".filter-input");

                if (select) {
                    // Multi-select: Get selected options
                    selectedValues = Array.from(select.selectedOptions).map(option => option.value.toLowerCase());
                } else if (input) {
                    // Input field: Get text value
                    selectedValues = [input.value.toLowerCase()];
                }

                document.querySelectorAll(`#tableBody .${column}-column`).forEach(cell => {
                    const row = cell.closest("tr");
                    const cellValue = cell.textContent.toLowerCase();

                    if (selectedValues.length > 0) {
                        // For multi-select or input, check if the cell value matches any selected value
                        if (selectedValues.some(value => cellValue.includes(value))) {
                            row.style.display = ""; // Show matching rows
                        } else {
                            row.style.display = "none"; // Hide non-matching rows
                        }
                    } else {
                        row.style.display = ""; // Show all rows if no filter applied
                    }
                });

                // Toggle filter icon indicator
                if (selectedValues.length > 0) {
                    filterIcon.classList.add("active");
                } else {
                    filterIcon.classList.remove("active");
                }

                // Close the filter menu
                filterMenu.classList.remove("show");
            });
        });


        // Clear filter
        document.querySelectorAll(".clear-filter-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const filterIcon = document.getElementById(`filter-icon-${column}`);
                const filterMenu = document.getElementById(`filter-${column}`);

                // Reset filters
                const select = filterMenu.querySelector(".filter-select");
                const input = filterMenu.querySelector(".filter-input");

                if (select) {
                    select.selectedIndex = -1; // Clear selection
                } else if (input) {
                    input.value = ""; // Clear input
                }

                // Show all rows
                document.querySelectorAll(`#tableBody .${column}-column`).forEach(cell => {
                    const row = cell.closest("tr");
                    row.style.display = "";
                });

                // Remove filter icon indicator
                filterIcon.classList.remove("active");

                // Close the filter menu
                filterMenu.classList.remove("show");
            });
        });

        // Sorting
        document.querySelectorAll(".sort-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const order = this.dataset.order;
                const sortIcon = document.getElementById(`sort-${column}`);
                const rows = Array.from(document.querySelectorAll("#tableBody tr"));

                // Determine if the column contains numeric data
                const isNumeric = rows.some(row => {
                    const value = row.querySelector(`.${column}-column`).textContent.trim();
                    return !isNaN(value) && value !== ""; // Check if value is numeric
                });

                rows.sort((a, b) => {
                    const aValue = a.querySelector(`.${column}-column`).textContent.trim();
                    const bValue = b.querySelector(`.${column}-column`).textContent.trim();

                    if (isNumeric) {
                        // Parse as numbers for numeric columns
                        return order === "asc" ? aValue - bValue : bValue - aValue;
                    } else {
                        // Use localeCompare for text columns
                        return order === "asc" ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }
                });

                rows.forEach(row => document.getElementById("tableBody").appendChild(row));
                this.dataset.order = order === "asc" ? "desc" : "asc";

                // Reset other sort icons
                document.querySelectorAll(".sort-icon").forEach(icon => {
                    if (icon !== sortIcon) {
                        icon.textContent = "‚¨Ü";
                        icon.classList.remove("active");
                    }
                });

                // Update sort icon
                if (order === "asc") {
                    sortIcon.textContent = "‚¨á";
                } else {
                    sortIcon.textContent = "‚¨Ü";
                }
                sortIcon.classList.add("active");
            });
        });

        // Close filter menus when clicking outside
        document.addEventListener("click", function (event) {
            if (!event.target.closest(".filter-icon") && !event.target.closest(".filter-menu")) {
                document.querySelectorAll(".filter-menu").forEach(menu => menu.classList.remove("show"));
            }
        });
    </script>
</body>

</html>