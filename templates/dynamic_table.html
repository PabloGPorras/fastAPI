<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Dynamic Table with Sorting and Filtering</title>
    <style>
        #manage-columns-menu {
            position: absolute;
            background: white;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            z-index: 1000;
        }

        .selected-row {
            background-color: #d3e4f7 !important;
        }

        .filter-icon {
            font-size: 18px;
            position: relative;
            cursor: pointer;
        }

        .filter-icon::after {
            content: '';
            display: none;
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background-color: #007bff;
            /* Blue indicator for active filters */
            border-radius: 50%;
        }

        .filter-icon.active::after {
            display: block;
        }

        .sort-icon {
            margin-left: 5px;
            cursor: pointer;
            color: gray;
            /* Default color */
        }

        .sort-icon.active {
            color: #007bff;
            /* Active sort color */
        }

        .filter-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 10;
        }

        .filter-menu.show {
            display: block;
        }

        .dropdown-item.disabled {
            pointer-events: none;
            opacity: 0.65;
        }
    </style>
</head>

<body>

    <div class="container mt-5">
        <h2>Dynamic Table with Sorting and Filtering</h2>
        <div class="mb-3 d-flex gap-2">
            <!-- Manage Columns Button -->
            <button id="manage-columns-btn" class="btn btn-primary btn-sm">Manage Columns</button>

            <!-- Create New Button Group -->
            <div class="btn-group">
                <!-- Primary Button triggers the modal -->
                <button id="primary-action-btn" class="btn btn-success btn-sm" data-bs-toggle="modal"
                    data-bs-target="#createNewModal">
                    Create New
                </button>
                <!-- Dropdown for additional actions -->
                <button type="button" class="btn btn-success btn-sm dropdown-toggle dropdown-toggle-split"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    {% for action in actions[1:] %}
                    <li>
                        <button class="dropdown-item requires-selection action-item"
                            data-endpoint="{{ action.endpoint }}">
                            {{ action.label }}
                        </button>
                    </li>
                    {% endfor %}
                    <li>
                        <button class="dropdown-item requires-selection" id="viewUpdateButton" data-bs-toggle="modal"
                            data-bs-target="#createNewModal">
                            View/Update
                        </button>
                    </li>

                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <!-- Bulk Import Upload -->
                    <li>
                        <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#uploadBulkModal">
                            Upload Bulk Import
                        </button>
                    </li>
                </ul>

            </div>
        </div>

        <div id="manage-columns-menu" class="border p-2"
            style="display: none; max-height: 200px; overflow-y: auto; width: 250px;">
            <form>
                {% for column in columns %}
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggle-{{ column.name }}"
                        data-column="{{ column.name }}" checked>
                    <label class="form-check-label" for="toggle-{{ column.name }}">{{ column.name|capitalize }}</label>
                </div>
                {% endfor %}
            </form>
        </div>
        <!-- Table -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    {% for column in columns %}
                    <th class="{{ column.name }}-column">
                        {{ column.name|capitalize }}
                        <button class="btn btn-link sort-btn" data-column="{{ column.name }}" data-order="asc">
                            <span id="sort-{{ column.name }}" class="sort-icon">‚¨Ü</span>
                        </button>
                        <span class="filter-icon" data-column="{{ column.name }}" id="filter-icon-{{ column.name }}"
                            title="Filter">üîç</span>
                        <div class="filter-menu" id="filter-{{ column.name }}">
                            {% if column.options %}
                            <select class="form-select form-select-sm filter-select mb-2"
                                data-column="{{ column.name }}" multiple>
                                {% for option in column.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="text" class="form-control form-control-sm filter-input mb-2"
                                data-column="{{ column.name }}" placeholder="Filter {{ column.name|capitalize }}">
                            {% endif %}
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm apply-filter-btn"
                                    data-column="{{ column.name }}">Apply</button>
                                <button class="btn btn-secondary btn-sm clear-filter-btn"
                                    data-column="{{ column.name }}">Clear</button>
                            </div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for row in rows %}
                <tr data-id="{{ row.id }}">
                    {% for column in columns %}
                    <td class="{{ column.name }}-column">{{ getattr(row, column.name) }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Create New Modal -->
    <div class="modal fade" id="createNewModal" tabindex="-1" aria-labelledby="createNewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createNewModalLabel">Create New Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createNewForm">
                    <div class="modal-body">
                        <!-- Dynamically generate main fields -->
                        <h5>Main Fields</h5>
                        {% for field in form_fields %}
                        <div class="mb-3">
                            <label for="{{ field.name }}" class="form-label">{{ field.name|capitalize }}</label>
                            {% if field.options %}
                            <!-- Dropdown for predefined options -->
                            <select class="form-select" id="{{ field.name }}" name="{{ field.name }}" required>
                                {% for option in field.options %}
                                <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                            {% elif "INTEGER" in field.type %}
                            <!-- Number input -->
                            <input type="number" class="form-control" id="{{ field.name }}" name="{{ field.name }}"
                                required>
                            {% else %}
                            <!-- Text input -->
                            <input type="text" class="form-control" id="{{ field.name }}" name="{{ field.name }}"
                                required>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <!-- Dynamically generate relationship subtables -->
                        {% for relationship in relationships %}
                        <h5>{{ relationship.name|capitalize }}</h5>
                        <div id="{{ relationship.name }}-container" class="relationship-container">
                            <!-- Subtable header -->
                            <table class="table">
                                <thead>
                                    <tr>
                                        {% for field in relationship.fields if field.name not in ["id", "person_id"] %}
                                        <th>{{ field.name|capitalize }}</th>
                                        {% endfor %}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be dynamically added here -->
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-secondary btn-sm mt-2 add-row-btn"
                                data-relationship="{{ relationship.name }}">Add {{ relationship.name|capitalize
                                }}</button>
                        </div>
                        {% endfor %}

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Place this near the modal or at the end of the body -->
    <script id="relationships-data" type="application/json">
    {{ relationships | tojson | safe }}
</script>


    <!-- Bulk Import Upload Modal -->
    <div class="modal fade" id="uploadBulkModal" tabindex="-1" aria-labelledby="uploadBulkModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadBulkModalLabel">Upload Bulk Import File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- File Upload Form -->
                    <form id="uploadBulkForm">
                        <div class="mb-3">
                            <label for="bulkFile" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="bulkFile" name="file" accept=".csv" required>
                        </div>
                        <div class="modal-footer">
                            <!-- Download Template Button -->
                            <a href="/bulk-import-template" class="btn btn-secondary" download>Download Template</a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


    <script id="model-data" type="application/json">
        {{ {"model_name": model_name, "relationships": relationships} | tojson | safe }}
    </script>

    <script>
        // Run this on page load to initialize the dropdown state
        updateDropdownActions();

        // Utility function to format field names
        function formatFieldName(fieldName) {
            return fieldName
                .split("_") // Split the string by underscores
                .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize the first letter of each word
                .join(" "); // Join the words with a space
        }


        // const relatives = [];
        // document.querySelectorAll("#relatives-container tbody tr").forEach(row => {
        //     const relative = {
        //         name: row.querySelector("input[name*='name']").value,
        //         relationship: row.querySelector("input[name*='relation_type']").value
        //     };
        //     relatives.push(relative);
        // });

        document.addEventListener("keydown", function (event) {
            const isCtrlPressed = event.ctrlKey || event.metaKey; // For macOS, `metaKey` is Cmd

            if (isCtrlPressed && event.key.toLowerCase() === "a") {
                event.preventDefault(); // Prevent default browser behavior

                // Select all rows
                document.querySelectorAll("#tableBody tr").forEach(row => {
                    row.classList.add("selected-row"); // Add the selected class
                });

                updateDropdownActions(); // Update dropdown actions
            }

            if (isCtrlPressed && event.key.toLowerCase() === "d") {
                event.preventDefault(); // Prevent default browser behavior

                // Deselect all rows
                document.querySelectorAll("#tableBody tr").forEach(row => {
                    row.classList.remove("selected-row"); // Remove the selected class
                });

                updateDropdownActions(); // Update dropdown actions
            }
        });


        document.getElementById("primary-action-btn").addEventListener("click", function () {
            // Reset the form
            const form = document.getElementById("createNewForm");
            form.reset();

            // Clear relationship tables
            document.querySelectorAll(".relationship-container tbody").forEach(container => {
                container.innerHTML = ""; // Clear all rows in relationship subtables
            });

            // Reset modal title and button
            const modalTitle = document.getElementById("createNewModalLabel");
            const saveButton = document.querySelector("#createNewModal .btn-primary");
            modalTitle.textContent = "Create New Entry";
            saveButton.textContent = "Save";
            saveButton.removeAttribute("data-id");
        });


        document.addEventListener("DOMContentLoaded", function () {
            // Add a single event listener for the "Add Relatives" button
            document.querySelectorAll(".add-row-btn").forEach(button => {
                button.addEventListener("click", function () {
                    const relationship = this.dataset.relationship;
                    const container = document.querySelector(`#${relationship}-container tbody`);
                    const index = container.children.length;

                    // Retrieve relationships data from the JSON script tag
                    let relationshipData;
                    try {
                        relationshipData = JSON.parse(document.getElementById('relationships-data').textContent);
                    } catch (error) {
                        console.error("Error parsing relationships data:", error);
                        return;
                    }

                    // Find the relationship configuration
                    const relationshipConfig = relationshipData.find(rel => rel.name === relationship);
                    if (!relationshipConfig || !relationshipConfig.fields) {
                        console.error(`No fields found for relationship: ${relationship}`);
                        return;
                    }

                    // Generate a new row with fields excluding "id" and "person_id"
                    const row = document.createElement("tr");
                    row.innerHTML = relationshipConfig.fields
                        .filter(field => field.name !== "id" && field.name !== "person_id") // Exclude unnecessary fields
                        .map(field => `
                <td>
                    <input type="${field.type.includes("INTEGER") ? "number" : "text"}" 
                           class="form-control" 
                           name="${relationship}[${index}][${field.name}]" 
                           placeholder="${formatFieldName(field.name)}" 
                           required>
                </td>
            `).join("") + `
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-row-btn">Remove</button>
                </td>
            `;

                    // Append the new row to the table body
                    container.appendChild(row);
                });
            });

            // Add a global event listener for dynamically created "Remove" buttons
            document.body.addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-row-btn")) {
                    const row = event.target.closest("tr");
                    row.remove();
                }
            });

            // View/Update button logic
            document.getElementById("viewUpdateButton").addEventListener("click", function () {
                const selectedRows = document.querySelectorAll(".selected-row");

                if (selectedRows.length !== 1) {
                    alert("Please select a single row to view/update.");
                    return;
                }

                const row = selectedRows[0]; // Get the selected row
                const rowId = row.getAttribute("data-id");

                // Fetch model metadata
                const modelData = JSON.parse(document.getElementById("model-data").textContent);
                const modelName = modelData.model_name;

                // Fetch the row data from the backend
                fetch(`/get-row/${modelName}/${rowId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Populate the modal with main data
                        for (const [key, value] of Object.entries(data)) {
                            if (Array.isArray(value)) continue; // Skip relationships for now
                            const input = document.getElementById(key);
                            if (input) {
                                input.value = value;
                            }
                        }

                        // Dynamically populate relationships
                        modelData.relationships.forEach(rel => {
                            const container = document.querySelector(`#${rel.name}-container tbody`);
                            if (container && data[rel.name]) {
                                container.innerHTML = ""; // Clear existing rows
                                data[rel.name].forEach((relatedRow, index) => {
                                    const row = document.createElement("tr");
                                    row.innerHTML = rel.fields
                                        .filter(field => field.name !== "id" && field.name !== "person_id") // Exclude primary keys
                                        .map(field => `
                    <td>
                        <input type="text" class="form-control" 
                               name="${rel.name}[${index}][${field.name}]" 
                               value="${relatedRow[field.name] || ''}" required>
                    </td>
                `).join("") + `
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-row-btn">Remove</button>
                    </td>
                `;
                                    container.appendChild(row);
                                });
                            }
                        });


                        // Update the modal title and action button
                        const modalTitle = document.getElementById("createNewModalLabel");
                        const saveButton = document.querySelector("#createNewModal .btn-primary");
                        modalTitle.textContent = "View/Update Entry";
                        saveButton.textContent = "Update";
                        saveButton.setAttribute("data-id", rowId);
                    })
                    .catch(error => console.error("Error fetching row data:", error));
            });


            // Update functionality
            document.getElementById("createNewForm").addEventListener("submit", async function (event) {
                event.preventDefault();

                const formData = new FormData(this);
                const formObject = {};
                const relationships = {};

                // Convert main form data to an object
                formData.forEach((value, key) => {
                    if (key.includes('[')) {
                        // Handle relationship fields
                        const [relationshipName, index, field] = key.match(/(\w+)\[(\d+)]\[(\w+)]/).slice(1);
                        if (!relationships[relationshipName]) relationships[relationshipName] = [];
                        if (!relationships[relationshipName][index]) relationships[relationshipName][index] = {};
                        relationships[relationshipName][index][field] = value;
                    } else {
                        // Handle main fields
                        formObject[key] = value;
                    }
                });

                // Add relationships to the form object
                formObject["relationships"] = relationships;

                // Determine the URL (update or create new)
                const rowId = document.querySelector("#createNewModal .btn-primary").getAttribute("data-id");
                const url = rowId ? `/update-row/${rowId}` : "/create-new";

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(formObject),
                    });

                    if (response.ok) {
                        alert("Operation successful!");
                        location.reload();
                    } else {
                        alert(`Operation failed: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Error during the operation:", error);
                    alert("An error occurred while performing the operation.");
                }
            });

        });






        // Bulk Import Form Submission
        document.getElementById("uploadBulkForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const fileInput = document.getElementById("bulkFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a CSV file to upload.");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch("/bulk-import", {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    // Close modal and refresh the table
                    const modalElement = document.getElementById("uploadBulkModal");
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    modalInstance.hide();
                    location.reload();
                } else {
                    alert(`Bulk import failed: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error uploading bulk import file:", error);
                alert("An error occurred while uploading the file.");
            }
        });


        // Function to update the state of dropdown items based on selected rows
        function updateDropdownActions() {
            const selectedRows = document.querySelectorAll(".selected-row");
            const dropdownItems = document.querySelectorAll(".dropdown-item.requires-selection");

            dropdownItems.forEach(item => {
                if (selectedRows.length === 0) {
                    item.classList.add("disabled"); // Add the disabled class if no rows are selected
                } else {
                    item.classList.remove("disabled"); // Remove the disabled class if rows are selected
                }
            });
        }


        // document.getElementById("createNewForm").addEventListener("submit", async function (event) {
        //     event.preventDefault(); // Prevent the form from submitting traditionally

        //     const formData = new FormData(this); // Capture form data
        //     const formObject = {};

        //     // Convert FormData to a plain object
        //     formData.forEach((value, key) => {
        //         formObject[key] = value;
        //     });

        //     console.log("Submitting formObject:", formObject); // Debug the data being sent

        //     try {
        //         const response = await fetch("http://localhost:8000/create-new", { // Use full URL
        //             method: "POST",
        //             headers: { "Content-Type": "application/json" },
        //             body: JSON.stringify(formObject),
        //         });

        //         if (response.ok) {
        //             const result = await response.json();
        //             console.log("Server response:", result); // Debug the server response
        //             // Optionally close the modal and refresh the table
        //             const modalElement = document.getElementById("createNewModal");
        //             const modalInstance = bootstrap.Modal.getInstance(modalElement);
        //             modalInstance.hide();
        //             // Refresh the table or reload the page
        //             location.reload(); // Or update the table dynamically
        //         } else {
        //             console.error(`Failed to create entry: ${response.statusText}`);
        //             alert(`Failed to create entry: ${response.statusText}`);
        //         }
        //     } catch (error) {
        //         console.error("Error submitting form:", error);
        //         alert("An error occurred while creating the entry.");
        //     }
        // });



        // Handle Dropdown Actions for specific action items
        document.querySelectorAll(".action-item").forEach(item => {
            item.addEventListener("click", async function () {
                const endpoint = this.dataset.endpoint; // Get the endpoint
                const selectedRows = document.querySelectorAll(".selected-row");

                if (selectedRows.length === 0) {
                    return; // Stop execution if no rows are selected
                }

                // Collect IDs of selected rows
                const selectedIds = Array.from(selectedRows).map(row => row.dataset.id);

                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ ids: selectedIds }), // Send valid JSON
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(`Action completed successfully: ${result.message}`);
                        location.reload(); // Optionally refresh the page
                    } else {
                        alert(`Action failed: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Error performing action:", error);
                    alert("An error occurred while performing the action.");
                }
            });
        });





        // Manage Columns Menu Toggle
        document.getElementById("manage-columns-btn").addEventListener("click", () => {
            const menu = document.getElementById("manage-columns-menu");
            menu.style.display = menu.style.display === "none" ? "block" : "none";
        });

        // Column Toggle Logic
        document.querySelectorAll(".column-toggle").forEach(toggle => {
            toggle.addEventListener("change", function () {
                const column = this.dataset.column;
                const th = document.querySelector(`th.${column}-column`);
                const tds = document.querySelectorAll(`td.${column}-column`);

                if (this.checked) {
                    th.style.display = ""; // Show column
                    tds.forEach(td => td.style.display = "");
                } else {
                    th.style.display = "none"; // Hide column
                    tds.forEach(td => td.style.display = "none");
                }
            });
        });


        // Attach row selection logic to toggle row selection
        document.querySelectorAll("#tableBody tr").forEach(row => {
            row.addEventListener("click", function () {
                // Toggle the "selected-row" class
                this.classList.toggle("selected-row");

                // Update the state of dropdown actions
                updateDropdownActions();
            });
        });

        // Prevent actions for disabled items
        document.querySelectorAll(".dropdown-item.requires-selection").forEach(item => {
            item.addEventListener("click", function (event) {
                if (this.classList.contains("disabled")) {
                    event.preventDefault(); // Prevent action if the item is disabled
                }
            });
        });


        // Show/hide filter menus
        document.querySelectorAll(".filter-icon").forEach(icon => {
            icon.addEventListener("click", function (event) {
                event.stopPropagation();
                const column = this.dataset.column;
                const filterMenu = document.getElementById(`filter-${column}`);
                document.querySelectorAll(".filter-menu").forEach(menu => {
                    if (menu !== filterMenu) {
                        menu.classList.remove("show");
                    }
                });
                filterMenu.classList.toggle("show");
            });
        });

        // Apply filter
        document.querySelectorAll(".apply-filter-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const filterIcon = document.getElementById(`filter-icon-${column}`);
                const filterMenu = document.getElementById(`filter-${column}`);
                let selectedValues = [];

                // Check if it's a multi-select or input filter
                const select = filterMenu.querySelector(".filter-select");
                const input = filterMenu.querySelector(".filter-input");

                if (select) {
                    // Multi-select: Get selected options
                    selectedValues = Array.from(select.selectedOptions).map(option => option.value.toLowerCase());
                } else if (input) {
                    // Input field: Get text value
                    selectedValues = [input.value.toLowerCase()];
                }

                document.querySelectorAll(`#tableBody .${column}-column`).forEach(cell => {
                    const row = cell.closest("tr");
                    const cellValue = cell.textContent.toLowerCase();

                    if (selectedValues.length > 0) {
                        // For multi-select or input, check if the cell value matches any selected value
                        if (selectedValues.some(value => cellValue.includes(value))) {
                            row.style.display = ""; // Show matching rows
                        } else {
                            row.style.display = "none"; // Hide non-matching rows
                        }
                    } else {
                        row.style.display = ""; // Show all rows if no filter applied
                    }
                });

                // Toggle filter icon indicator
                if (selectedValues.length > 0) {
                    filterIcon.classList.add("active");
                } else {
                    filterIcon.classList.remove("active");
                }

                // Close the filter menu
                filterMenu.classList.remove("show");
            });
        });


        // Clear filter
        document.querySelectorAll(".clear-filter-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const filterIcon = document.getElementById(`filter-icon-${column}`);
                const filterMenu = document.getElementById(`filter-${column}`);

                // Reset filters
                const select = filterMenu.querySelector(".filter-select");
                const input = filterMenu.querySelector(".filter-input");

                if (select) {
                    select.selectedIndex = -1; // Clear selection
                } else if (input) {
                    input.value = ""; // Clear input
                }

                // Show all rows
                document.querySelectorAll(`#tableBody .${column}-column`).forEach(cell => {
                    const row = cell.closest("tr");
                    row.style.display = "";
                });

                // Remove filter icon indicator
                filterIcon.classList.remove("active");

                // Close the filter menu
                filterMenu.classList.remove("show");
            });
        });

        // Sorting
        document.querySelectorAll(".sort-btn").forEach(button => {
            button.addEventListener("click", function () {
                const column = this.dataset.column;
                const order = this.dataset.order;
                const sortIcon = document.getElementById(`sort-${column}`);
                const rows = Array.from(document.querySelectorAll("#tableBody tr"));

                // Determine if the column contains numeric data
                const isNumeric = rows.some(row => {
                    const value = row.querySelector(`.${column}-column`).textContent.trim();
                    return !isNaN(value) && value !== ""; // Check if value is numeric
                });

                rows.sort((a, b) => {
                    const aValue = a.querySelector(`.${column}-column`).textContent.trim();
                    const bValue = b.querySelector(`.${column}-column`).textContent.trim();

                    if (isNumeric) {
                        // Parse as numbers for numeric columns
                        return order === "asc" ? aValue - bValue : bValue - aValue;
                    } else {
                        // Use localeCompare for text columns
                        return order === "asc" ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }
                });

                rows.forEach(row => document.getElementById("tableBody").appendChild(row));
                this.dataset.order = order === "asc" ? "desc" : "asc";

                // Reset other sort icons
                document.querySelectorAll(".sort-icon").forEach(icon => {
                    if (icon !== sortIcon) {
                        icon.textContent = "‚¨Ü";
                        icon.classList.remove("active");
                    }
                });

                // Update sort icon
                if (order === "asc") {
                    sortIcon.textContent = "‚¨á";
                } else {
                    sortIcon.textContent = "‚¨Ü";
                }
                sortIcon.classList.add("active");
            });
        });

        // Close filter menus when clicking outside
        document.addEventListener("click", function (event) {
            if (!event.target.closest(".filter-icon") && !event.target.closest(".filter-menu")) {
                document.querySelectorAll(".filter-menu").forEach(menu => menu.classList.remove("show"));
            }
        });
    </script>
</body>

</html>