<!-- Hidden template for row actions -->
<template id="row-action-template">
    <div class="row-action-container d-flex align-items-center" style="gap: 10px; height: 40px;">
        <!-- Checkbox -->
        <input type="checkbox" class="form-check-input row-checkbox" name="selected_rows" value=""
            style="height: 100%; width: 40px; display: flex; align-items: center; justify-content: center;">

        <!-- Button Group -->
        <div class="btn-group dropend" style="height: 100%; width: 40px;">
            <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false" style="height: 100%; width: 100%;">
                <i class="fas fa-bolt"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <button type="button" class="dropdown-item text-primary view-btn">
                        <i class="fas fa-eye"></i> View
                    </button>
                </li>
                <li>
                    <button type="button" class="dropdown-item text-warning edit-btn">
                        <i class="fas fa-edit me-2"></i> Edit
                    </button>
                </li>
                <li>
                    {% include "perf_metrics_button.html" %}
                </li>
            </ul>
        </div>
    </div>
</template>




<!-- Container to hold the modal loaded via AJAX -->
<div id="modalContainer"></div>

<script>
    function getActionsColumn() {
        return {
            title: "",
            data: null,
            orderable: false,
            searchable: false,
            className: "text-center",
            render: function (data, type, row) {
                let template = document.getElementById("row-action-template");
                let clone = template.content.cloneNode(true);

                let checkbox = clone.querySelector(".row-checkbox");
                checkbox.value = row.unique_ref;

                let viewBtn = clone.querySelector(".view-btn");
                let editBtn = clone.querySelector(".edit-btn");
                let perfMetricsBtn = clone.querySelector(".perf-metrics-btn");

                viewBtn.setAttribute("data-unique-ref", row.unique_ref);
                viewBtn.setAttribute("data-request-type", row.request_type);

                if (editBtn) {
                    editBtn.setAttribute("data-unique-ref", row.unique_ref);
                    editBtn.setAttribute("data-request-type", row.request_type);
                    editBtn.setAttribute("data-status", row.status);
                }

                if (perfMetricsBtn) {
                    perfMetricsBtn.setAttribute("data-group-id", row.group_id);
                }

                // ‚úÖ Conditionally remove the Edit button if not allowed
                if (!row.has_edit_existing) {
                    if (editBtn && editBtn.parentElement) {
                        editBtn.parentElement.remove(); // Remove the <li> that contains the button
                    }
                }

                return clone.firstElementChild.outerHTML;
            }
        };
    }



    $(document).ready(function () {
        $("body").on("click", ".view-btn", function () {
            let uniqueRef = $(this).attr("data-unique-ref");
            let requestType = $(this).attr("data-request-type");
            let userRoles = "{{ user.roles }}";  // ‚úÖ Injected directly from Jinja2
            let userName = "{{ user.user_name }}";  // ‚úÖ Injected directly from Jinja2
            let model_name = "{{ model_name }}";  // ‚úÖ Injected directly from Jinja2

            console.log(`Fetching details for uniqueRef: ${uniqueRef}`);
            console.log(`Fetching details for userRoles: ${userRoles}`);
            console.log(`Fetching details for modelName: ${model_name}`);

            $.ajax({
                url: "/get-view-existing-form",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ unique_ref: uniqueRef, model_name: model_name, user_roles: userRoles, user_name: userName, request_type: requestType }),
                success: function (response) {


                    // Clear any previously injected modal markup
                    $("#modalContainer").html(response);

                    // Ensure the modal is shown
                    $("#viewExistingModal").modal("show");

                    // Force HTMX to process dynamically loaded content
                    htmx.process($("#modalContainer")[0]);
                },
                error: function (xhr, status, error) {
                    console.error("‚ùå Error fetching details:", xhr.responseText);
                    alert("Failed to load details. Please try again.");
                }
            });
        });
        $("body").on("click", ".edit-btn", function () {
            let uniqueRef = $(this).attr("data-unique-ref");
            let requestType = $(this).attr("data-request-type");
            let status = $(this).attr("data-status");
            let user_roles = "{{ user.roles }}";  // Injected from Jinja2
            let userName = "{{ user.user_name }}";  // Injected from Jinja2
            let model_name = "{{ model_name }}";  // Injected from Jinja2

            console.log(`Editing uniqueRef: ${uniqueRef}`);
            console.log(`Request type: ${requestType}`);
            console.log(`Status: ${status}`);
            console.log(`user_roles: ${user_roles}`);

            $.ajax({
                url: "/get-edit-existing-form",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    unique_ref: uniqueRef,
                    request_type: requestType,
                    user_roles: user_roles,
                    user_name: userName,
                    model_name: model_name,
                    status: status
                }),
                success: function (response) {
                    // Inject the modal
                    $("#modalContainer").html(response);

                    // Show the modal
                    $("#viewExistingModal").modal("show");

                    // üîÅ Force HTMX to process dynamic content (enables hx-trigger="revealed")
                    htmx.process($("#modalContainer")[0]);
                },
                error: function (xhr, status, error) {
                    console.error("‚ùå Error loading edit form:", xhr.responseText);
                    alert("Failed to load edit form. Please try again.");
                }
            });
        });





    });
</script>