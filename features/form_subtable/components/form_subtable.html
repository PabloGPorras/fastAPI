{% for relationship in metadata.relationships %}
<h5>{{ relationship.name|capitalize }}</h5>
{% set nested = relationship.nested_metadata %}

{% if nested.already_visited %}
<p>Already visited {{ nested.model_name }}...</p>
{% else %}
<div class="table-responsive">
    <table class="table table-bordered" data-relationship="{{ relationship.name }}">
        <thead>
            <tr>
                {% for field in nested.form_fields %}
                    {% set display_name = field.field_name if field.field_name else field.name %}
                <th class="minwidth-cell">{{ display_name|capitalize }}</th>
                {% endfor %}
                {% if form_name == 'create-new' %}
                <th class="minwidth-cell">Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for row in relationship_data.get(relationship.name, []) %}
            <tr>
                {% for field in nested.form_fields %}
                    {% set display_name = field.field_name if field.field_name else field.name %}
                <td>{{ row[display_name] }}</td>
                {% endfor %}
                {% if form_name == 'create-new' %}
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-row-btn" data-relationship="{{ relationship.name }}">
                        Remove
                    </button>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            {% if form_name == 'create-new' %}
            <tr>
                {% for field in nested.form_fields %}
                    {% set display_name = field.field_name if field.field_name else field.name %}
                    {% set is_required = field.required %}
                    {% set is_enabled = field.forms[form_name]['enabled'] if field and field.forms.get(form_name) else True %}
                    {% set max_length = field.length %}
                <td>
                    {% if field.multi_select %}
                    <select class="form-select add-field-input" data-field="{{ display_name }}" multiple 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %}>
                        {% for option in field.column_options %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>

                    {% elif field.column_options %}
                    <select class="form-select add-field-input" data-field="{{ display_name }}" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %}>
                        <option value="">--Select--</option>
                        {% for option in field.column_options %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>

                    {% elif "INTEGER" in field.type %}
                    <input type="number" class="form-control add-field-input" data-field="{{ display_name }}" value="" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %} 
                        {% if max_length %}max="{{ max_length }}"{% endif %}>

                    {% elif "BOOLEAN" in field.type %}
                    <select class="form-select add-field-input" data-field="{{ display_name }}" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %}>
                        <option value="">--Select--</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>

                    {% elif "DATETIME" in field.type %}
                    <input type="datetime-local" class="form-control add-field-input" data-field="{{ display_name }}" value="" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %}>

                    {% elif "DATE" in field.type %}
                    <input type="date" class="form-control add-field-input" data-field="{{ display_name }}" value="" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %}>

                    {% else %}
                    <textarea class="form-control resizable add-field-input" rows="1" data-field="{{ display_name }}" 
                        {% if is_required %}required{% endif %} 
                        {% if not is_enabled %}disabled{% endif %} 
                        {% if max_length %}maxlength="{{ max_length }}"{% endif %}></textarea>
                    {% endif %}
                </td>
                {% endfor %}
                <td>
                    <button type="button" class="btn btn-primary btn-sm add-row-btn" data-relationship="{{ relationship.name }}">
                        Add
                    </button>
                </td>
            </tr>
            {% endif %}
        </tfoot>
    </table>
</div>
{% endif %}
{% endfor %}



<!-- Hidden field for relationships data -->
<input type="hidden" id="relationshipsInput" name="relationships" value="{}" />

<script>
// Prevent multiple declarations
window.relationshipsData = window.relationshipsData || {};

function updateRelationshipsInput() {
  const relationshipsInput = document.getElementById("relationshipsInput");
  relationshipsInput.value = JSON.stringify(window.relationshipsData);
  console.log("Updated relationshipsInput:", relationshipsInput.value);
}

// Attach event listeners only once (avoid reattaching when HTMX reloads parts of the page)
document.body.addEventListener("click", (event) => {
  if (event.target.matches(".add-row-btn")) {
    const relationshipName = event.target.dataset.relationship;
    const table = event.target.closest("table");
    const tbody = table.querySelector("tbody");

    const rowInputs = table.querySelectorAll(".add-field-input");
    const rowData = {};

    rowInputs.forEach((input) => {
      const fieldName = input.dataset.field;
      rowData[fieldName] = input.value;
    });

    const isValid = Object.values(rowData).every((value) => value.trim() !== "");
    if (!isValid) {
      alert("Please fill in all fields before adding a row.");
      return;
    }

    const newRow = document.createElement("tr");
    for (const [colName, val] of Object.entries(rowData)) {
      const td = document.createElement("td");
      td.textContent = val;
      newRow.appendChild(td);
    }

    const actionsTd = document.createElement("td");
    actionsTd.innerHTML = `
      <button type="button" class="btn btn-danger btn-sm remove-row-btn" data-relationship="${relationshipName}">
        Remove
      </button>
    `;
    newRow.appendChild(actionsTd);

    tbody.appendChild(newRow);
    rowInputs.forEach((i) => (i.value = ""));

    if (!window.relationshipsData[relationshipName]) {
      window.relationshipsData[relationshipName] = [];
    }
    window.relationshipsData[relationshipName].push(rowData);
    updateRelationshipsInput();
  }

  if (event.target.matches(".remove-row-btn")) {
    const relationshipName = event.target.dataset.relationship;
    const row = event.target.closest("tr");
    const rowIndex = Array.from(row.parentElement.children).indexOf(row);

    if (window.relationshipsData[relationshipName]) {
      window.relationshipsData[relationshipName].splice(rowIndex, 1);
    }

    row.remove();
    updateRelationshipsInput();
  }
});

  </script>
  