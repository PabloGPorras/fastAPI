<!-- Predefined form fields / Search Fields -->
{% include "field_search.html" %}

{% macro render_select(name, options, required, multiple, value, enabled) %}
<select class="form-select" name="{{ name }}{% if multiple %}[]{% endif %}"
        {% if required %}required{% endif %}
        {% if multiple %}multiple{% endif %}
        {% if not enabled %}disabled{% endif %}>
    {% for option in options %}
    <option value="{{ option }}" {% if option == value %}selected{% endif %}>{{ option }}</option>
    {% endfor %}
</select>
{% endmacro %}

{% macro render_input(name, type, required, max_length, value, enabled) %}
<input type="{{ type }}" class="form-control" name="{{ name }}"
       {% if required %}required{% endif %}
       {% if max_length %}maxlength="{{ max_length }}"{% endif %}
       {% if value %}value="{{ value }}"{% endif %}
       {% if not enabled %}disabled{% endif %}>
{% endmacro %}

{% for group in grouped_fields %}
    <h5>{{ group.group_name }}</h5>
    {% for field in group.fields %}
    {% set is_required_now = field.required %}
    <div class="mb-3 form-field"
         data-field-name="{{ field.name }}"
         data-visibility-conditions='{{ field.visibility_conditions | tojson | safe }}'
         data-is-required="{{ field.required | lower }}"
         data-is-shown="true">

        <label for="{{ field.name }}">{{ field.display_name }}{% if field.required %}*{% endif %}</label>

        {% if field.options %}
            {{ render_select(field.name, field.options,
                is_required_now,
                field.multi_select,
                field.value,
                field.enabled) }}
        {% elif "INTEGER" in field.type %}
            {{ render_input(field.name, "number",
                is_required_now,
                field.max_length,
                field.value,
                field.enabled) }}
        {% elif "BOOLEAN" in field.type %}
            {{ render_select(field.name, ["true", "false"],
                is_required_now,
                False,
                field.value,
                field.enabled) }}
        {% elif "DATETIME" in field.type %}
            {{ render_input(field.name, "datetime-local",
                is_required_now,
                None,
                field.value,
                field.enabled) }}
        {% elif "DATE" in field.type %}
            {{ render_input(field.name, "date",
                is_required_now,
                None,
                field.value,
                field.enabled) }}
        {% else %}
            <textarea class="form-control resizable" rows="1" name="{{ field.name }}"
                      {% if field.max_length %}maxlength="{{ field.max_length }}"{% endif %}
                      {% if is_required_now %}required{% endif %}
                      {% if not field.enabled %}disabled{% endif %}>{{ field.value or "" }}</textarea>
        {% endif %}

    </div>
    {% endfor %}
{% endfor %}

<script>
(function() {
    console.log("[Script] FORM FIELDS event fired.");
    const fields = document.querySelectorAll('.form-field');

    function checkCondition(values, condition) {
        if (condition.show_if) {
            const expected = condition.show_if.map(v => v.trim().toLowerCase());
            return values.some(val => expected.includes(val.trim().toLowerCase()));
        }
        return false;
    }

    window.evaluateVisibility = function evaluateVisibility() {
        fields.forEach(field => {
            const conditions = JSON.parse(field.dataset.visibilityConditions || "[]");
            const isRequired = field.dataset.isRequired === 'true';
            let visible = true;

            if (conditions.length > 0) {
                conditions.forEach(cond => {
                    const target = document.querySelector(`[name="${cond.field}"], [name="${cond.field}[]"]`);
                    if (!target) {
                        visible = false;
                        return;
                    }

                    let values = [];
                    if (target.multiple) {
                        values = Array.from(target.selectedOptions).map(o => o.value);
                    } else {
                        values = [target.value];
                    }

                    if (!checkCondition(values, cond)) {
                        visible = false;
                    }
                });
            }

            field.dataset.isShown = visible;
            field.style.display = visible ? 'block' : 'none';

            const input = field.querySelector('input, select, textarea');
            if (input) {
                if (visible && isRequired) {
                    input.setAttribute('required', 'required');
                } else {
                    input.removeAttribute('required');
                }

                if (!visible) {
                    if (input.tagName === 'SELECT') {
                        input.selectedIndex = -1;
                    } else {
                        input.value = '';
                    }
                }
            }
        });
    };

    evaluateVisibility();

    document.querySelectorAll('.form-field input, .form-field select, .form-field textarea').forEach(el => {
        el.addEventListener('input', evaluateVisibility);
        el.addEventListener('change', evaluateVisibility);
    });
})();
</script>
