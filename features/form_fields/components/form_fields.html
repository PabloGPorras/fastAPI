{% macro render_select(name, options, required, multiple, value, enabled) %}
<select class="form-select" name="{{ name }}{% if multiple %}[]{% endif %}"
        {% if required %}required{% endif %}
        {% if multiple %}multiple{% endif %}
        {% if not enabled %}disabled{% endif %}>
    {% for option in options %}
    <option value="{{ option }}" {% if option == value %}selected{% endif %}>{{ option }}</option>
    {% endfor %}
</select>
{% endmacro %}

{% macro render_input(name, type, required, max_length, value, enabled) %}
<input type="{{ type }}" class="form-control" name="{{ name }}"
       {% if required %}required{% endif %}
       {% if max_length %}maxlength="{{ max_length }}"{% endif %}
       {% if value %}value="{{ value }}"{% endif %}
       {% if not enabled %}disabled{% endif %}>
{% endmacro %}

{% for field in form_fields %}
<div class="mb-3 form-field"
     data-field-name="{{ field.name }}"
     data-visibility-conditions='{{ field.visibility_conditions | tojson | safe }}'
     data-required-if-visible="{{ field.required_if_visible | lower }}">

    <!-- âœ… Keep display name in label for user-friendliness -->
    <label for="{{ field.name }}">{{ field.display_name }}{% if field.required %}*{% endif %}</label>

    {% if field.options %}
        {{ render_select(field.name, field.options, field.required, field.multi_select, field.value, field.enabled) }}
    {% elif "INTEGER" in field.type %}
        {{ render_input(field.name, "number", field.required, field.max_length, field.value, field.enabled) }}
    {% elif "BOOLEAN" in field.type %}
        {{ render_select(field.name, ["true", "false"], field.required, False, field.value, field.enabled) }}
    {% elif "DATETIME" in field.type %}
        {{ render_input(field.name, "datetime-local", field.required, None, field.value, field.enabled) }}
    {% elif "DATE" in field.type %}
        {{ render_input(field.name, "date", field.required, None, field.value, field.enabled) }}
    {% else %}
    <textarea class="form-control resizable" rows="1" name="{{ field.name }}"
                  {% if field.required %}required{% endif %}
                  {% if field.max_length %}maxlength="{{ field.max_length }}"{% endif %}
                  {% if not field.enabled %}disabled{% endif %}>{{ field.value or "" }}</textarea>
    {% endif %}
</div>
{% endfor %}

<script>
(function() {
    console.log("[Script] FORM FIELDS event fired.");
    const fields = document.querySelectorAll('.form-field');

    function checkCondition(values, condition) {
        if (condition.show_if) {
            // Normalize expected values to lower-case and trimmed
            const expected = condition.show_if.map(v => v.trim().toLowerCase());
            return values.some(val => expected.includes(val.trim().toLowerCase()));
        }
        return false;
    }

    function evaluateVisibility() {
        fields.forEach(field => {
            const conditions = JSON.parse(field.dataset.visibilityConditions || "[]");
            let visible = conditions.length === 0 ? true : true;

            conditions.forEach(cond => {
                const target = document.querySelector(`[name="${cond.field}"], [name="${cond.field}[]"]`);
                if (!target) {
                    visible = false;
                    return;
                }
                let values = [];
                if (target.multiple) {
                    values = Array.from(target.selectedOptions).map(o => o.value);
                } else {
                    values = [target.value];
                }
                if (!checkCondition(values, cond)) {
                    visible = false;
                }
            });

            field.style.display = visible ? 'block' : 'none';

            // Handle required dynamically based on visibility and required_if_visible
            const requiredIfVisible = field.dataset.requiredIfVisible === 'true';
            const input = field.querySelector('input, select, textarea');
            if (input) {
                if (visible && requiredIfVisible) {
                    input.setAttribute('required', 'required');
                } else {
                    input.removeAttribute('required');
                }
            }
        });
    }

    evaluateVisibility();

    document.querySelectorAll('.form-field input, .form-field select, .form-field textarea').forEach(el => {
        el.addEventListener('input', evaluateVisibility);
        el.addEventListener('change', evaluateVisibility);
    });
})();
</script>
