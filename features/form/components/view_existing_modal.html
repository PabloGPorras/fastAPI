<div class="modal fade" id="viewExistingModal" tabindex="-1" aria-labelledby="viewExistingModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewExistingModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" id="viewDetailsTabPane" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                            data-bs-target="#details-tab-pane" type="button" role="tab" aria-controls="details-tab-pane"
                            aria-selected="true">
                            Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                            data-bs-target="#comments-tab-pane" type="button" role="tab"
                            aria-controls="comments-tab-pane" aria-selected="false">
                            Comments
                        </button>
                    </li>
                    <!-- New Checklist Tab -->
                    {% if "IMPL_Specialist" in user_roles.split(",") %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="checklist-tab" data-bs-toggle="tab"
                            data-bs-target="#checklist-tab-pane" type="button" role="tab"
                            aria-controls="checklist-tab-pane" aria-selected="false">
                            Checklist
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Details Tab -->
                    <div class="tab-pane fade show active" id="details-tab-pane" role="tabpanel"
                        aria-labelledby="details-tab">
                        <form id="detailsForm">
                            <!-- Container for Dynamic Header Fields -->
                            {% if is_request %}
                            <div id="form-header-container-view"
                                hx-post="/get-form-header?&is_request={{ is_request }}&user_name={{ user.user_name }}&unique_ref={{ unique_ref }}&form_name={{ form_name }}"
                                hx-trigger="revealed"
                                hx-target="#form-header-container-view"
                                hx-swap="innerHTML">
                            <p>Loading header fields...</p>
                            </div>
                            {% endif %}

                            
                            <!-- Render the Main Form Fields -->
                            <div id="form-fields-container-view"
                                hx-post="/get-form-fields?model_name={{ model_name }}&form_name={{ form_name }}&unique_ref={{ unique_ref }}"
                                hx-trigger="revealed"
                                hx-target="#form-fields-container-view"
                                hx-swap="innerHTML">
                                <p>Loading form fields...</p>
                            </div>

                            <!-- Render the Relationship Tables -->
                            <div id="relationship-subtable-view"
                                hx-get="/get-relationship-subtable?model_name={{ model_name }}&form_name={{ form_name }}&unique_ref={{ unique_ref }}"
                                hx-trigger="revealed"
                                hx-target="#relationship-subtable-view"
                                hx-swap="innerHTML">
                                <p>Loading subtable...</p>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </form>
                    </div>

                    <!-- Comments Tab -->
                    <div id="comments-tab-pane" class="tab-pane fade" role="tabpanel" aria-labelledby="comments-tab">
                        <h5>Comments</h5>

                        <!-- HTMX Container for Loading Comments List + Form -->
                        <div id="comments-container-view"
                            hx-post="/requests/{{ unique_ref }}/comments/template"
                            hx-trigger="revealed"
                            hx-target="#comments-container-view"
                            hx-swap="innerHTML">
                            <p>Loading comments...</p>
                        </div>
                    </div>

                    <!-- Checklist Tab -->

                </div>
            </div>
        </div>
    </div>
</div>
<script>

    $(document).ready(function () {
        // Add New Multi-Options to Fields
        $(".add-option-btn").click(function () {
            const fieldName = $(this).data("field"); // Field name for which options are being added
            const input = $(this).prev(".add-option-input"); // Input element for adding new options
            const newOption = input.val().trim(); // Get the entered option

            if (!newOption) {
                alert("Option cannot be empty.");
                return;
            }

            // Get the corresponding select element
            const select = $(`#${fieldName}`);
            if (!select.length) {
                alert("Select element not found.");
                return;
            }

            // Check for duplicates
            if (select.find(`option[value="${newOption}"]`).length) {
                alert("Option already exists.");
                return;
            }

            // Add the new option to the select dropdown
            select.append(new Option(newOption, newOption));

            // Clear the input field
            input.val("");
        });

        // Add Predefined Options as Rows
        $(".add-predefined-btn").click(function () {
            const relationship = $(this).data("relationship");
            const container = $(`#${relationship}-container tbody`);
            const dropdown = $(`#${relationship}_options`);
            const selectedValue = dropdown.val();
            const selectedText = dropdown.find("option:selected").text();

            if (!selectedValue) return;

            // Check for duplicates before adding
            if (container.find(`tr[data-value="${selectedValue}"]`).length) {
                alert(`This ${relationship} is already added.`);
                return;
            }

            // Add new row
            const row = $(`<tr data-value="${selectedValue}"></tr>`);
            row.append(`<td>${selectedText}</td>`);
            row.append('<td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Remove</button></td>');
            container.append(row);
        });

        // Handle Row Removal
        $("body").on("click", ".remove-row-btn", function () {
            $(this).closest("tr").remove();
        });
    });

</script>